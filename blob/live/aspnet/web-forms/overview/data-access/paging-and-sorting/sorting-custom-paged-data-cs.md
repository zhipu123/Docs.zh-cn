---
uid: web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-cs
title: "排序自定义分页数据 (C#) |Microsoft 文档"
author: rick-anderson
description: "在以前的教程，我们学习了如何实现自定义分页时 presentating 在网页上的数据。 在本教程中我们将了解如何以扩展前面..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 08/15/2006
ms.topic: article
ms.assetid: 778baa4e-4af8-4665-947e-7a01d1a4dff2
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-cs
msc.type: authoredcontent
ms.openlocfilehash: f171929da3610f70f3641030d9a5fdb88f610f7f
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/10/2017
---
<a name="sorting-custom-paged-data-c"></a><span data-ttu-id="465e9-104">排序自定义分页数据 (C#)</span><span class="sxs-lookup"><span data-stu-id="465e9-104">Sorting Custom Paged Data (C#)</span></span>
====================
<span data-ttu-id="465e9-105">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="465e9-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="465e9-106">[下载示例应用程序](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_CS.exe)或[下载 PDF](sorting-custom-paged-data-cs/_static/datatutorial26cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="465e9-106">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_CS.exe) or [Download PDF](sorting-custom-paged-data-cs/_static/datatutorial26cs1.pdf)</span></span>

> <span data-ttu-id="465e9-107">在以前的教程，我们学习了如何实现自定义分页时 presentating 在网页上的数据。</span><span class="sxs-lookup"><span data-stu-id="465e9-107">In the previous tutorial we learned how to implement custom paging when presentating data on a web page.</span></span> <span data-ttu-id="465e9-108">在本教程中我们将了解如何以扩展前面的示例，用以排序自定义分页的支持。</span><span class="sxs-lookup"><span data-stu-id="465e9-108">In this tutorial we see how to extend the preceding example to include support for sorting custom paging.</span></span>


## <a name="introduction"></a><span data-ttu-id="465e9-109">介绍</span><span class="sxs-lookup"><span data-stu-id="465e9-109">Introduction</span></span>

<span data-ttu-id="465e9-110">与默认分页，请比较自定义分页可以通过几个数量级，使自定义分页事实上分页实现选项，当大量的数据进行分页时提高性能的数据进行分页。</span><span class="sxs-lookup"><span data-stu-id="465e9-110">Compared to default paging, custom paging can improve the performance of paging through data by several orders of magnitude, making custom paging the de facto paging implementation choice when paging through large amounts of data.</span></span> <span data-ttu-id="465e9-111">实现自定义分页是更多地涉及而不是实现默认的分页，但是，尤其是在添加到组合排序。</span><span class="sxs-lookup"><span data-stu-id="465e9-111">Implementing custom paging is more involved than implementing default paging, however, especially when adding sorting to the mix.</span></span> <span data-ttu-id="465e9-112">在本教程中，我们将扩展的示例中前一次用以支持排序*和*自定义分页。</span><span class="sxs-lookup"><span data-stu-id="465e9-112">In this tutorial we'll extend the example from the preceding one to include support for sorting *and* custom paging.</span></span>

> [!NOTE]
> <span data-ttu-id="465e9-113">由于本教程基于前一次，然后开始才一段时间来复制中的声明性语法`<asp:Content>`从前面的教程 s web 页的元素 (`EfficientPaging.aspx`) 并将其之间粘贴`<asp:Content>`中元素`SortParameter.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="465e9-113">Since this tutorial builds upon the preceding one, before beginning take a moment to copy the declarative syntax within the `<asp:Content>` element from the preceding tutorial s web page (`EfficientPaging.aspx`) and paste it between the `<asp:Content>` element in the `SortParameter.aspx` page.</span></span> <span data-ttu-id="465e9-114">回头参考的步骤 1 中[将验证控件添加到的编辑和插入接口](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)教程，以复制到另一个一个 ASP.NET 页的功能的更多详细讨论。</span><span class="sxs-lookup"><span data-stu-id="465e9-114">Refer back to Step 1 of the [Adding Validation Controls to the Editing and Inserting Interfaces](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md) tutorial for a more detailed discussion on replicating the functionality of one ASP.NET page to another.</span></span>


## <a name="step-1-reexamining-the-custom-paging-technique"></a><span data-ttu-id="465e9-115">步骤 1： 重新检查的自定义分页技术</span><span class="sxs-lookup"><span data-stu-id="465e9-115">Step 1: Reexamining the Custom Paging Technique</span></span>

<span data-ttu-id="465e9-116">若要正常工作的自定义分页，我们必须实现某些技术，它可以有效地获取给定的开始的行索引和最大行数参数的记录的特定子集。</span><span class="sxs-lookup"><span data-stu-id="465e9-116">For custom paging to work properly, we must implement some technique that can efficiently grab a particular subset of records given the Start Row Index and Maximum Rows parameters.</span></span> <span data-ttu-id="465e9-117">有几种可用来实现此目标的技术。</span><span class="sxs-lookup"><span data-stu-id="465e9-117">There are a handful of techniques that can be used to achieve this aim.</span></span> <span data-ttu-id="465e9-118">在前面的教程，我们实现此操作查看使用 Microsoft SQL Server 2005 s 新`ROW_NUMBER()`排名函数。</span><span class="sxs-lookup"><span data-stu-id="465e9-118">In the preceding tutorial we looked at accomplishing this using Microsoft SQL Server 2005 s new `ROW_NUMBER()` ranking function.</span></span> <span data-ttu-id="465e9-119">简单地说，`ROW_NUMBER()`排名函数将按指定的排序顺序排名的查询返回的每一行分配一个行号。</span><span class="sxs-lookup"><span data-stu-id="465e9-119">In short, the `ROW_NUMBER()` ranking function assigns a row number to each row returned by a query that is ranked by a specified sort order.</span></span> <span data-ttu-id="465e9-120">然后通过返回的已编号的结果的特定部分，获取记录的相应的子集。</span><span class="sxs-lookup"><span data-stu-id="465e9-120">The appropriate subset of records is then obtained by returning a particular section of the numbered results.</span></span> <span data-ttu-id="465e9-121">下面的查询演示如何使用此方法返回时排名结果按字母顺序排列的编号 11 至第 20 这些产品`ProductName`:</span><span class="sxs-lookup"><span data-stu-id="465e9-121">The following query illustrates how to use this technique to return those products numbered 11 through 20 when ranking the results ordered alphabetically by the `ProductName`:</span></span>


[!code-sql[Main](sorting-custom-paged-data-cs/samples/sample1.sql)]

<span data-ttu-id="465e9-122">此方法非常适用于使用特定的排序顺序的分页 (`ProductName`按字母顺序排列，这种情况下)，但查询需要修改可显示按不同的排序表达式的结果。</span><span class="sxs-lookup"><span data-stu-id="465e9-122">This technique works well for paging using a specific sort order (`ProductName` sorted alphabetically, in this case), but the query needs to be modified to show the results sorted by a different sort expression.</span></span> <span data-ttu-id="465e9-123">理想情况下，上述查询可重写用于中的参数`OVER`子句，如下所示：</span><span class="sxs-lookup"><span data-stu-id="465e9-123">Ideally, the above query could be rewritten to use a parameter in the `OVER` clause, like so:</span></span>


[!code-sql[Main](sorting-custom-paged-data-cs/samples/sample2.sql)]

<span data-ttu-id="465e9-124">遗憾的是，参数化`ORDER BY`子句不允许。</span><span class="sxs-lookup"><span data-stu-id="465e9-124">Unfortunately, parameterized `ORDER BY` clauses are not allowed.</span></span> <span data-ttu-id="465e9-125">相反，我们必须创建存储的过程接受的`@sortExpression`输入的参数，但使用同一种的下列解决方法：</span><span class="sxs-lookup"><span data-stu-id="465e9-125">Instead, we must create a stored procedure that accepts a `@sortExpression` input parameter, but uses one of the following workarounds:</span></span>

- <span data-ttu-id="465e9-126">为每个可能使用; 的排序表达式编写硬编码的查询然后，使用`IF/ELSE`T-SQL 的语句，以确定要执行的查询。</span><span class="sxs-lookup"><span data-stu-id="465e9-126">Write hard-coded queries for each of the sort expressions that may be used; then, use `IF/ELSE` T-SQL statements to determine which query to execute.</span></span>
- <span data-ttu-id="465e9-127">使用`CASE`语句，以提供动态`ORDER BY`表达式基于`@sortExpressio`n 输入参数，请参阅动态排序查询结果部分中使用[的 SQL Power`CASE`语句](http://www.4guysfromrolla.com/webtech/102704-1.shtml)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="465e9-127">Use a `CASE` statement to provide dynamic `ORDER BY` expressions based on the `@sortExpressio` n input parameter; see the Used to Dynamically Sort Query Results section in [The Power of SQL `CASE` Statements](http://www.4guysfromrolla.com/webtech/102704-1.shtml) for more information.</span></span>
- <span data-ttu-id="465e9-128">作为字符串存储过程中创建相应的查询，然后使用[`sp_executesql`系统存储过程](https://msdn.microsoft.com/en-us/library/ms188001.aspx)执行动态查询。</span><span class="sxs-lookup"><span data-stu-id="465e9-128">Craft the appropriate query as a string in the stored procedure and then use [the `sp_executesql` system stored procedure](https://msdn.microsoft.com/en-us/library/ms188001.aspx) to execute the dynamic query.</span></span>

<span data-ttu-id="465e9-129">每个这些解决方法存在一些缺点。</span><span class="sxs-lookup"><span data-stu-id="465e9-129">Each of these workarounds has some drawbacks.</span></span> <span data-ttu-id="465e9-130">第一个选项不是作为与其他两个因为它需要你创建的每个可能的排序表达式的查询为容易维护的。</span><span class="sxs-lookup"><span data-stu-id="465e9-130">The first option is not as maintainable as the other two as it requires that you create a query for each possible sort expression.</span></span> <span data-ttu-id="465e9-131">因此，如果以后决定要将新的、 可排序的字段添加到 GridView 你还需要返回并更新存储的过程。</span><span class="sxs-lookup"><span data-stu-id="465e9-131">Therefore, if later you decide to add new, sortable fields to the GridView you will also need to go back and update the stored procedure.</span></span> <span data-ttu-id="465e9-132">第二种方法都有一些细微部分按非字符串数据库列进行排序时产生性能问题，还会受到与第一个相同的可维护性问题。</span><span class="sxs-lookup"><span data-stu-id="465e9-132">The second approach has some subtleties that introduce performance concerns when sorting by non-string database columns and also suffers from the same maintainability issues as the first.</span></span> <span data-ttu-id="465e9-133">和第三个选项，使用动态 SQL，引入了 SQL 注入攻击的风险，如果攻击者能够执行存储的过程在其选择的输入的参数值传递。</span><span class="sxs-lookup"><span data-stu-id="465e9-133">And the third choice, which uses dynamic SQL, introduces the risk for a SQL injection attack if an attacker is able to execute the stored procedure passing in the input parameter values of their choosing.</span></span>

<span data-ttu-id="465e9-134">虽然这些方法不完美，我认为第三个选项是最佳的三个。</span><span class="sxs-lookup"><span data-stu-id="465e9-134">While none of these approaches is perfect, I think the third option is the best of the three.</span></span> <span data-ttu-id="465e9-135">对它的动态 SQL 的使用，它提供其他两个不这样做的灵活性的级别。</span><span class="sxs-lookup"><span data-stu-id="465e9-135">With its use of dynamic SQL, it offers a level of flexibility the other two do not.</span></span> <span data-ttu-id="465e9-136">此外，仅如果攻击者能够执行存储的过程在其选择的输入参数中传递时，只有可以利用 SQL 注入攻击。</span><span class="sxs-lookup"><span data-stu-id="465e9-136">Furthermore, a SQL injection attack can only be exploited if an attacker is able to execute the stored procedure passing in the input parameters of his choice.</span></span> <span data-ttu-id="465e9-137">由于 DAL 使用参数化的查询，ADO.NET 将保护发送到数据库中通过体系结构，这些参数，这意味着如果攻击者可以直接执行存储的过程，仅存在 SQL 注入攻击漏洞。</span><span class="sxs-lookup"><span data-stu-id="465e9-137">Since the DAL uses parameterized queries, ADO.NET will protect those parameters that are sent to the database through the architecture, meaning that the SQL injection attack vulnerability only exists if the attacker can directly execute the stored procedure.</span></span>

<span data-ttu-id="465e9-138">若要实现此功能，在名为 Northwind 数据库中创建新的存储的过程`GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="465e9-138">To implement this functionality, create a new stored procedure in the Northwind database named `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="465e9-139">此存储的过程应接受三个输入参数： `@sortExpression`，输入的参数的类型`nvarchar(100`)，用于指定如何结果应进行排序和后直接注入`ORDER BY`中文`OVER`子句; 和`@startRowIndex`和`@maximumRows`，从相同的两个整数输入的参数`GetProductsPaged`存储检查在前面的教程的过程。</span><span class="sxs-lookup"><span data-stu-id="465e9-139">This stored procedure should accept three input parameters: `@sortExpression`, an input parameter of type `nvarchar(100`) that specifies how the results should be sorted and is injected directly after the `ORDER BY` text in the `OVER` clause; and `@startRowIndex` and `@maximumRows`, the same two integer input parameters from the `GetProductsPaged` stored procedure examined in the preceding tutorial.</span></span> <span data-ttu-id="465e9-140">创建`GetProductsPagedAndSorted`存储过程使用以下脚本：</span><span class="sxs-lookup"><span data-stu-id="465e9-140">Create the `GetProductsPagedAndSorted` stored procedure using the following script:</span></span>


[!code-sql[Main](sorting-custom-paged-data-cs/samples/sample3.sql)]

<span data-ttu-id="465e9-141">通过确保的值来启动存储的过程`@sortExpression`指定参数。</span><span class="sxs-lookup"><span data-stu-id="465e9-141">The stored procedure starts by ensuring that a value for the `@sortExpression` parameter has been specified.</span></span> <span data-ttu-id="465e9-142">如果缺少，结果按顺序排列的`ProductID`。</span><span class="sxs-lookup"><span data-stu-id="465e9-142">If it is missing, the results are ranked by `ProductID`.</span></span> <span data-ttu-id="465e9-143">接下来，将构造动态的 SQL 查询。</span><span class="sxs-lookup"><span data-stu-id="465e9-143">Next, the dynamic SQL query is constructed.</span></span> <span data-ttu-id="465e9-144">请注意动态的 SQL 查询从我们以前用于从 Products 表中检索所有行的查询会稍有不同。</span><span class="sxs-lookup"><span data-stu-id="465e9-144">Note that the dynamic SQL query here differs slightly from our previous queries used to retrieve all rows from the Products table.</span></span> <span data-ttu-id="465e9-145">在前面的示例，我们获得每个产品 s 关联的类别使用子查询的 s 和供应商的名称。</span><span class="sxs-lookup"><span data-stu-id="465e9-145">In prior examples, we obtained each product s associated category s and supplier s names using a subquery.</span></span> <span data-ttu-id="465e9-146">返回做出此决定是[创建数据访问层](../introduction/creating-a-data-access-layer-cs.md)教程和已完成而非使用`JOIN`s 因为 TableAdapter 无法自动创建关联的插入、 更新和删除方法对这些产品查询。</span><span class="sxs-lookup"><span data-stu-id="465e9-146">This decision was made back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial and was done in lieu of using `JOIN` s because the TableAdapter cannot automatically create the associated insert, update, and delete methods for such queries.</span></span> <span data-ttu-id="465e9-147">`GetProductsPagedAndSorted`存储的过程，但是，必须使用`JOIN`s，结果才会按类别或供应商名称进行排序。</span><span class="sxs-lookup"><span data-stu-id="465e9-147">The `GetProductsPagedAndSorted` stored procedure, however, must use `JOIN` s for the results to be ordered by the category or supplier names.</span></span>

<span data-ttu-id="465e9-148">此动态查询通过串联静态查询部分构建和`@sortExpression`， `@startRowIndex`，和`@maximumRows`参数。</span><span class="sxs-lookup"><span data-stu-id="465e9-148">This dynamic query is built up by concatenating the static query portions and the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="465e9-149">由于`@startRowIndex`和`@maximumRows`整数参数，它们必须转换为 nvarchars 为了正确连接。</span><span class="sxs-lookup"><span data-stu-id="465e9-149">Since `@startRowIndex` and `@maximumRows` are integer parameters, they must be converted into nvarchars in order to be correctly concatenated.</span></span> <span data-ttu-id="465e9-150">一旦构造此动态 SQL 查询后，执行通过`sp_executesql`。</span><span class="sxs-lookup"><span data-stu-id="465e9-150">Once this dynamic SQL query has been constructed, it is executed via `sp_executesql`.</span></span>

<span data-ttu-id="465e9-151">花一些时间来测试不同的值与此存储的过程`@sortExpression`， `@startRowIndex`，和`@maximumRows`参数。</span><span class="sxs-lookup"><span data-stu-id="465e9-151">Take a moment to test this stored procedure with different values for the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="465e9-152">从服务器资源管理器，右键单击存储的过程名称并选择执行。</span><span class="sxs-lookup"><span data-stu-id="465e9-152">From the Server Explorer, right-click on the stored procedure name and choose Execute.</span></span> <span data-ttu-id="465e9-153">此时会弹出运行存储过程对话框中，可以在其中输入 （请参见图 1） 的输入的参数。</span><span class="sxs-lookup"><span data-stu-id="465e9-153">This will bring up the Run Stored Procedure dialog box into which you can enter the input parameters (see Figure 1).</span></span> <span data-ttu-id="465e9-154">若要按类别名称对结果进行排序，请使用有关 CategoryName`@sortExpression`参数值; 若要按供应商的公司名称进行排序，请使用公司名称。</span><span class="sxs-lookup"><span data-stu-id="465e9-154">To sort the results by the category name, use CategoryName for the `@sortExpression` parameter value; to sort by the supplier s company name, use CompanyName.</span></span> <span data-ttu-id="465e9-155">提供的参数值后, 单击确定。</span><span class="sxs-lookup"><span data-stu-id="465e9-155">After providing the parameters values, click OK.</span></span> <span data-ttu-id="465e9-156">结果将显示在输出窗口中。</span><span class="sxs-lookup"><span data-stu-id="465e9-156">The results are displayed in the Output window.</span></span> <span data-ttu-id="465e9-157">图 2 显示的结果，通过排序时，返回产品排名 11 至第 20 后`UnitPrice`降序排序。</span><span class="sxs-lookup"><span data-stu-id="465e9-157">Figure 2 shows the results when returning products ranked 11 through 20 when ordering by the `UnitPrice` in descending order.</span></span>


![为存储的过程 s 三个输入参数尝试不同的值](sorting-custom-paged-data-cs/_static/image1.png)

<span data-ttu-id="465e9-159">**图 1**： 为存储的过程 s 三个输入参数，请尝试不同的值</span><span class="sxs-lookup"><span data-stu-id="465e9-159">**Figure 1**: Try Different Values for the Stored Procedure s Three Input Parameters</span></span>


<span data-ttu-id="465e9-160">[![存储过程的结果将显示在输出窗口](sorting-custom-paged-data-cs/_static/image3.png)](sorting-custom-paged-data-cs/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="465e9-160">[![The Stored Procedure s Results are Shown in the Output Window](sorting-custom-paged-data-cs/_static/image3.png)](sorting-custom-paged-data-cs/_static/image2.png)</span></span>

<span data-ttu-id="465e9-161">**图 2**: 存储过程的结果将显示在输出窗口中 ([单击以查看实际尺寸的图像](sorting-custom-paged-data-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="465e9-161">**Figure 2**: The Stored Procedure s Results are Shown in the Output Window ([Click to view full-size image](sorting-custom-paged-data-cs/_static/image4.png))</span></span>


> [!NOTE]
> <span data-ttu-id="465e9-162">当指定排名结果`ORDER BY`中的列`OVER`子句，SQL Server 必须将对结果进行排序。</span><span class="sxs-lookup"><span data-stu-id="465e9-162">When ranking the results by the specified `ORDER BY` column in the `OVER` clause, SQL Server must sort the results.</span></span> <span data-ttu-id="465e9-163">这是快速操作，如果通过对结果进行由正在排序的列没有聚集的索引，或者如果没有覆盖索引，但会否则成本较高。</span><span class="sxs-lookup"><span data-stu-id="465e9-163">This is a quick operation if there is a clustered index over the column(s) the results are being ordered by or if there is a covering index, but can be more costly otherwise.</span></span> <span data-ttu-id="465e9-164">若要提高足够大，查询的性能，请考虑添加按对结果排序所依据的列的非聚集索引。</span><span class="sxs-lookup"><span data-stu-id="465e9-164">To improve performance for sufficiently large queries, consider adding a non-clustered index for the column by which the results are ordered by.</span></span> <span data-ttu-id="465e9-165">请参阅[排名函数和 SQL Server 2005 中的性能](http://www.sql-server-performance.com/ak_ranking_functions.asp)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="465e9-165">Refer to [Ranking Functions and Performance in SQL Server 2005](http://www.sql-server-performance.com/ak_ranking_functions.asp) for more details.</span></span>


## <a name="step-2-augmenting-the-data-access-and-business-logic-layers"></a><span data-ttu-id="465e9-166">步骤 2： 补充数据访问层和业务逻辑层</span><span class="sxs-lookup"><span data-stu-id="465e9-166">Step 2: Augmenting the Data Access and Business Logic Layers</span></span>

<span data-ttu-id="465e9-167">与`GetProductsPagedAndSorted`创建的存储的过程，我们的下一步是提供一种方式来执行该存储的过程通过我们的应用程序体系结构。</span><span class="sxs-lookup"><span data-stu-id="465e9-167">With the `GetProductsPagedAndSorted` stored procedure created, our next step is to provide a means to execute that stored procedure through our application architecture.</span></span> <span data-ttu-id="465e9-168">这需要将适当的方法添加到的 DAL 和 BLL。</span><span class="sxs-lookup"><span data-stu-id="465e9-168">This entails adding an appropriate method to both the DAL and BLL.</span></span> <span data-ttu-id="465e9-169">让我们来开始与 DAL 添加方法。</span><span class="sxs-lookup"><span data-stu-id="465e9-169">Let s start by adding a method to the DAL.</span></span> <span data-ttu-id="465e9-170">打开`Northwind.xsd`类型化数据集，右键单击`ProductsTableAdapter`，然后从上下文菜单中选择添加查询选项。</span><span class="sxs-lookup"><span data-stu-id="465e9-170">Open the `Northwind.xsd` Typed DataSet, right-click on the `ProductsTableAdapter`, and choose the Add Query option from the context menu.</span></span> <span data-ttu-id="465e9-171">正如我们做在前面的教程，我们想要配置要使用现有存储的过程的此新 DAL 方法`GetProductsPagedAndSorted`，在这种情况下。</span><span class="sxs-lookup"><span data-stu-id="465e9-171">As we did in the preceding tutorial, we want to configure this new DAL method to use an existing stored procedure - `GetProductsPagedAndSorted`, in this case.</span></span> <span data-ttu-id="465e9-172">首先，该值指示你想要使用现有存储的过程的新的 TableAdapter 方法。</span><span class="sxs-lookup"><span data-stu-id="465e9-172">Start by indicating that you want the new TableAdapter method to use an existing stored procedure.</span></span>


![选择使用现有存储的过程](sorting-custom-paged-data-cs/_static/image5.png)

<span data-ttu-id="465e9-174">**图 3**： 选择使用现有存储的过程</span><span class="sxs-lookup"><span data-stu-id="465e9-174">**Figure 3**: Choose to Use an Existing Stored Procedure</span></span>


<span data-ttu-id="465e9-175">若要指定要使用的存储的过程，请选择`GetProductsPagedAndSorted`存储过程从下拉列表中下一个屏幕。</span><span class="sxs-lookup"><span data-stu-id="465e9-175">To specify the stored procedure to use, select the `GetProductsPagedAndSorted` stored procedure from the drop-down list in the next screen.</span></span>


![使用 GetProductsPagedAndSorted 存储过程](sorting-custom-paged-data-cs/_static/image6.png)

<span data-ttu-id="465e9-177">**图 4**： 使用 GetProductsPagedAndSorted 存储过程</span><span class="sxs-lookup"><span data-stu-id="465e9-177">**Figure 4**: Use the GetProductsPagedAndSorted Stored Procedure</span></span>


<span data-ttu-id="465e9-178">此存储的过程返回一组记录，因为其结果是，在下一步的屏幕中，指示它返回表格数据。</span><span class="sxs-lookup"><span data-stu-id="465e9-178">This stored procedure returns a set of records as its results so, in the next screen, indicate that it returns tabular data.</span></span>


![指示存储的过程返回表格数据](sorting-custom-paged-data-cs/_static/image7.png)

<span data-ttu-id="465e9-180">**图 5**： 指示存储的过程返回表格数据</span><span class="sxs-lookup"><span data-stu-id="465e9-180">**Figure 5**: Indicate that the Stored Procedure Returns Tabular Data</span></span>


<span data-ttu-id="465e9-181">最后，创建一个数据表的使用这两个填充的 DAL 方法并返回 DataTable 模式，命名方法`FillPagedAndSorted`和`GetProductsPagedAndSorted`分别。</span><span class="sxs-lookup"><span data-stu-id="465e9-181">Finally, create DAL methods that use both the Fill a DataTable and Return a DataTable patterns, naming the methods `FillPagedAndSorted` and `GetProductsPagedAndSorted`, respectively.</span></span>


![选择的方法名称](sorting-custom-paged-data-cs/_static/image8.png)

<span data-ttu-id="465e9-183">**图 6**： 选择的方法名称</span><span class="sxs-lookup"><span data-stu-id="465e9-183">**Figure 6**: Choose the Methods Names</span></span>


<span data-ttu-id="465e9-184">现在我们已扩展 DAL，我们已准备好变为 BLL 重新。</span><span class="sxs-lookup"><span data-stu-id="465e9-184">Now that we ve extended the DAL, we re ready to turn to the BLL.</span></span> <span data-ttu-id="465e9-185">打开`ProductsBLL`类文件，并添加新方法， `GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="465e9-185">Open the `ProductsBLL` class file and add a new method, `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="465e9-186">此方法需要接受三个输入参数`sortExpression`， `startRowIndex`，和`maximumRows`只应调用到 DAL 的`GetProductsPagedAndSorted`方法，如下所示：</span><span class="sxs-lookup"><span data-stu-id="465e9-186">This method needs to accept three input parameters `sortExpression`, `startRowIndex`, and `maximumRows` and should simply call down into the DAL s `GetProductsPagedAndSorted` method, like so:</span></span>


[!code-csharp[Main](sorting-custom-paged-data-cs/samples/sample4.cs)]

## <a name="step-3-configuring-the-objectdatasource-to-pass-in-the-sortexpression-parameter"></a><span data-ttu-id="465e9-187">步骤 3： 配置 SortExpression 参数中传递 ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="465e9-187">Step 3: Configuring the ObjectDataSource to Pass in the SortExpression Parameter</span></span>

<span data-ttu-id="465e9-188">要包括的方法，利用的 DAL 和 BLL 具有扩充`GetProductsPagedAndSorted`存储的过程，所有保持是配置中的 ObjectDataSource`SortParameter.aspx`页以使用新的 BLL 方法并传入`SortExpression`参数基于用户已请求的结果进行排序的列。</span><span class="sxs-lookup"><span data-stu-id="465e9-188">Having augmented the DAL and BLL to include methods that utilize the `GetProductsPagedAndSorted` stored procedure, all that remains is to configure the ObjectDataSource in the `SortParameter.aspx` page to use the new BLL method and to pass in the `SortExpression` parameter based on the column that the user has requested to sort the results by.</span></span>

<span data-ttu-id="465e9-189">通过更改 ObjectDataSource s 启动`SelectMethod`从`GetProductsPaged`到`GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="465e9-189">Start by changing the ObjectDataSource s `SelectMethod` from `GetProductsPaged` to `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="465e9-190">这可以通过配置数据源向导，从属性窗口中，或直接通过声明性语法。</span><span class="sxs-lookup"><span data-stu-id="465e9-190">This can be done through the Configure Data Source wizard, from the Properties window, or directly through the declarative syntax.</span></span> <span data-ttu-id="465e9-191">接下来，我们需要提供一个值，ObjectDataSource s [ `SortParameterName`属性](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx)。</span><span class="sxs-lookup"><span data-stu-id="465e9-191">Next, we need to provide a value for the ObjectDataSource s [`SortParameterName` property](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx).</span></span> <span data-ttu-id="465e9-192">如果设置此属性，尝试在 GridView 传递 ObjectDataSource`SortExpression`属性`SelectMethod`。</span><span class="sxs-lookup"><span data-stu-id="465e9-192">If this property is set, the ObjectDataSource attempts to pass in the GridView s `SortExpression` property to the `SelectMethod`.</span></span> <span data-ttu-id="465e9-193">具体而言，ObjectDataSource 查找的输入参数，其名称是等于的值`SortParameterName`属性。</span><span class="sxs-lookup"><span data-stu-id="465e9-193">In particular, the ObjectDataSource looks for an input parameter whose name is equal to the value of the `SortParameterName` property.</span></span> <span data-ttu-id="465e9-194">由于 BLL s`GetProductsPagedAndSorted`方法具有名为的排序表达式输入的参数`sortExpression`，设置 ObjectDataSource 的`SortExpression`sortExpression 属性。</span><span class="sxs-lookup"><span data-stu-id="465e9-194">Since the BLL s `GetProductsPagedAndSorted` method has the sort expression input parameter named `sortExpression`, set the ObjectDataSource s `SortExpression` property to sortExpression .</span></span>

<span data-ttu-id="465e9-195">进行这些两个更改后，ObjectDataSource s 声明性语法应类似于以下：</span><span class="sxs-lookup"><span data-stu-id="465e9-195">After making these two changes, the ObjectDataSource s declarative syntax should look similar to the following:</span></span>


[!code-aspx[Main](sorting-custom-paged-data-cs/samples/sample5.aspx)]

> [!NOTE]
> <span data-ttu-id="465e9-196">如前面的教程中，确保 ObjectDataSource*不*其 SelectParameters 集合中包括的 sortExpression、 值或值的输入的参数。</span><span class="sxs-lookup"><span data-stu-id="465e9-196">As with the preceding tutorial, ensure that the ObjectDataSource does *not* include the sortExpression, startRowIndex, or maximumRows input parameters in its SelectParameters collection.</span></span>


<span data-ttu-id="465e9-197">若要启用在 GridView 中排序，只需选中 GridView s 智能标记，它将设置 GridView s 中的启用排序复选框`AllowSorting`属性`true`，从而导致每个列以将呈现为 LinkButton 的页眉文本。</span><span class="sxs-lookup"><span data-stu-id="465e9-197">To enable sorting in the GridView, simply check the Enable Sorting checkbox in the GridView s smart tag, which sets the GridView s `AllowSorting` property to `true` and causing the header text for each column to be rendered as a LinkButton.</span></span> <span data-ttu-id="465e9-198">当最终用户单击其中一个标头 LinkButtons 时，回发时，才会和经过以下步骤：</span><span class="sxs-lookup"><span data-stu-id="465e9-198">When the end user clicks on one of the header LinkButtons, a postback ensues and the following steps transpire:</span></span>

1. <span data-ttu-id="465e9-199">GridView 更新其[`SortExpression`属性](https://msdn.microsoft.com/en-US/library/system.web.ui.webcontrols.gridview.sortexpression.aspx)为的值`SortExpression`被单击其标头链接的字段</span><span class="sxs-lookup"><span data-stu-id="465e9-199">The GridView updates its [`SortExpression` property](https://msdn.microsoft.com/en-US/library/system.web.ui.webcontrols.gridview.sortexpression.aspx) to the value of the `SortExpression` of the field whose header link was clicked</span></span>
2. <span data-ttu-id="465e9-200">ObjectDataSource 调用 BLL s`GetProductsPagedAndSorted`方法，同时传入 GridView s`SortExpression`方法 s 的值作为属性`sortExpression`输入的参数 (以及相应`startRowIndex`和`maximumRows`输入参数值)</span><span class="sxs-lookup"><span data-stu-id="465e9-200">The ObjectDataSource invokes the BLL s `GetProductsPagedAndSorted` method, passing in the GridView s `SortExpression` property as the value for the method s `sortExpression` input parameter (along with the appropriate `startRowIndex` and `maximumRows` input parameter values)</span></span>
3. <span data-ttu-id="465e9-201">BLL 调用 DAL 的`GetProductsPagedAndSorted`方法</span><span class="sxs-lookup"><span data-stu-id="465e9-201">The BLL invokes the DAL s `GetProductsPagedAndSorted` method</span></span>
4. <span data-ttu-id="465e9-202">DAL 执行`GetProductsPagedAndSorted`传递存储过程中，在`@sortExpression`参数 (连同`@startRowIndex`和`@maximumRows`输入参数值)</span><span class="sxs-lookup"><span data-stu-id="465e9-202">The DAL executes the `GetProductsPagedAndSorted` stored procedure, passing in the `@sortExpression` parameter (along with the `@startRowIndex` and `@maximumRows` input parameter values)</span></span>
5. <span data-ttu-id="465e9-203">存储的过程返回相应的数据子集为 BLL，将其返回给 ObjectDataSource;然后绑定到 GridView，转换为 html 代码，并向最终用户向下发送此数据</span><span class="sxs-lookup"><span data-stu-id="465e9-203">The stored procedure returns the appropriate subset of data to the BLL, which returns it to the ObjectDataSource; this data is then bound to the GridView, rendered into HTML, and sent down to the end user</span></span>

<span data-ttu-id="465e9-204">图 7 显示时按排序的结果的第一页`UnitPrice`升序排序。</span><span class="sxs-lookup"><span data-stu-id="465e9-204">Figure 7 shows the first page of results when sorted by the `UnitPrice` in ascending order.</span></span>


<span data-ttu-id="465e9-205">[![对结果进行排序单价](sorting-custom-paged-data-cs/_static/image10.png)](sorting-custom-paged-data-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="465e9-205">[![The Results are Sorted by the UnitPrice](sorting-custom-paged-data-cs/_static/image10.png)](sorting-custom-paged-data-cs/_static/image9.png)</span></span>

<span data-ttu-id="465e9-206">**图 7**: 单价的结果进行排序 ([单击以查看实际尺寸的图像](sorting-custom-paged-data-cs/_static/image11.png))</span><span class="sxs-lookup"><span data-stu-id="465e9-206">**Figure 7**: The Results are Sorted by the UnitPrice ([Click to view full-size image](sorting-custom-paged-data-cs/_static/image11.png))</span></span>


<span data-ttu-id="465e9-207">时的当前实现可以正确排序按产品名称、 类别名称、 每个单元和单价数量的结果，请尝试对结果进行排序供应商名称结果在运行时异常 （请参阅图 8）。</span><span class="sxs-lookup"><span data-stu-id="465e9-207">While the current implementation can correctly sort the results by product name, category name, quantity per unit, and unit price, attempting to order the results by the supplier name results in a runtime exception (see Figure 8).</span></span>


![尝试通过以下运行时异常中的供应商结果对结果进行排序](sorting-custom-paged-data-cs/_static/image12.png)

<span data-ttu-id="465e9-209">**图 8**： 尝试通过以下运行时异常中的供应商结果对结果进行排序</span><span class="sxs-lookup"><span data-stu-id="465e9-209">**Figure 8**: Attempting to Sort the Results by the Supplier Results in the Following Runtime Exception</span></span>


<span data-ttu-id="465e9-210">发生此异常的原因`SortExpression`的 GridView s `SupplierName` BoundField 设置为`SupplierName`。</span><span class="sxs-lookup"><span data-stu-id="465e9-210">This exception occurs because the `SortExpression` of the GridView s `SupplierName` BoundField is set to `SupplierName`.</span></span> <span data-ttu-id="465e9-211">但是，供应商 s 中的名称`Suppliers`表实际上调用`CompanyName`我们已被使用别名作为此列的列名`SupplierName`。</span><span class="sxs-lookup"><span data-stu-id="465e9-211">However, the supplier s name in the `Suppliers` table is actually called `CompanyName` we have been aliased this column name as `SupplierName`.</span></span> <span data-ttu-id="465e9-212">但是，`OVER`子句使用`ROW_NUMBER()`函数不能使用别名，并且必须使用为实际列名。</span><span class="sxs-lookup"><span data-stu-id="465e9-212">However, the `OVER` clause used by the `ROW_NUMBER()` function cannot use the alias and must use the actual column name.</span></span> <span data-ttu-id="465e9-213">因此，更改`SupplierName`BoundField 的`SortExpression`从 CompanyName 到供应商的名称 （请参阅图 9）。</span><span class="sxs-lookup"><span data-stu-id="465e9-213">Therefore, change the `SupplierName` BoundField s `SortExpression` from SupplierName to CompanyName (see Figure 9).</span></span> <span data-ttu-id="465e9-214">如图 10 显示，此更改后的结果可以进行排序供应商。</span><span class="sxs-lookup"><span data-stu-id="465e9-214">As Figure 10 shows, after this change the results can be sorted by the supplier.</span></span>


![将供应商名称 BoundField 的 SortExpression 更改为 CompanyName](sorting-custom-paged-data-cs/_static/image13.png)

<span data-ttu-id="465e9-216">**图 9**： 将供应商名称 BoundField 的 SortExpression 更改为 CompanyName</span><span class="sxs-lookup"><span data-stu-id="465e9-216">**Figure 9**: Change the SupplierName BoundField s SortExpression to CompanyName</span></span>


<span data-ttu-id="465e9-217">[![现在可以按供应商排序结果](sorting-custom-paged-data-cs/_static/image15.png)](sorting-custom-paged-data-cs/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="465e9-217">[![The Results Can Now Be Sorted by Supplier](sorting-custom-paged-data-cs/_static/image15.png)](sorting-custom-paged-data-cs/_static/image14.png)</span></span>

<span data-ttu-id="465e9-218">**图 10**: 结果可以现在按进行排序供应商 ([单击以查看实际尺寸的图像](sorting-custom-paged-data-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="465e9-218">**Figure 10**: The Results Can Now Be Sorted by Supplier ([Click to view full-size image](sorting-custom-paged-data-cs/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="465e9-219">摘要</span><span class="sxs-lookup"><span data-stu-id="465e9-219">Summary</span></span>

<span data-ttu-id="465e9-220">我们探讨了前面教程中的自定义分页实现所需在设计时指定结果打算进行排序所依据的顺序。</span><span class="sxs-lookup"><span data-stu-id="465e9-220">The custom paging implementation we examined in the preceding tutorial required that the order by which the results were to be sorted be specified at design time.</span></span> <span data-ttu-id="465e9-221">简单地说，这意味着，我们实现的自定义分页实现无法，同时，提供排序功能。</span><span class="sxs-lookup"><span data-stu-id="465e9-221">In short, this meant that the custom paging implementation we implemented could not, at the same time, provide sorting capabilities.</span></span> <span data-ttu-id="465e9-222">在本教程中我们可以克服此限制了通过扩展存储的过程从第一个包括`@sortExpression`结果无法排序所依据的输入的参数。</span><span class="sxs-lookup"><span data-stu-id="465e9-222">In this tutorial we overcame this limitation by extending the stored procedure from the first to include a `@sortExpression` input parameter by which the results could be sorted.</span></span>

<span data-ttu-id="465e9-223">创建此存储过程和 DAL 和 BLL 中创建新的方法后，我们只需能够实现一个 GridView，提供这两个排序和自定义分页通过配置对象数据源以传入 GridView s 当前`SortExpression`BLL 属性`SelectMethod`.</span><span class="sxs-lookup"><span data-stu-id="465e9-223">After creating this stored procedure and creating new methods in the DAL and BLL, we were able to implement a GridView that offered both sorting and custom paging by configuring the ObjectDataSource to pass in the GridView s current `SortExpression` property to the BLL `SelectMethod`.</span></span>

<span data-ttu-id="465e9-224">尽情享受编程 ！</span><span class="sxs-lookup"><span data-stu-id="465e9-224">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="465e9-225">关于作者</span><span class="sxs-lookup"><span data-stu-id="465e9-225">About the Author</span></span>

<span data-ttu-id="465e9-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七个 ASP/ASP.NET 书籍和的创始人[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年使用与 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="465e9-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="465e9-227">Scott 的作用是作为独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="465e9-227">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="465e9-228">最新书籍是[ *Sam 教授自己 ASP.NET 2.0 24 小时内*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="465e9-228">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="465e9-229">他可以达到在[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)或通过他的博客，其中可以找到在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="465e9-229">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="465e9-230">特别感谢</span><span class="sxs-lookup"><span data-stu-id="465e9-230">Special Thanks To</span></span>

<span data-ttu-id="465e9-231">本教程系列已由许多有用的审阅者评审。</span><span class="sxs-lookup"><span data-stu-id="465e9-231">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="465e9-232">本教程中的前导审阅者已 Carlos Santos。</span><span class="sxs-lookup"><span data-stu-id="465e9-232">Lead reviewer for this tutorial was Carlos Santos.</span></span> <span data-ttu-id="465e9-233">对感兴趣查看我即将到来的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="465e9-233">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="465e9-234">如果是这样，删除我一行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="465e9-234">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="465e9-235">[上一页](efficiently-paging-through-large-amounts-of-data-cs.md)
[下一页](creating-a-customized-sorting-user-interface-cs.md)</span><span class="sxs-lookup"><span data-stu-id="465e9-235">[Previous](efficiently-paging-through-large-amounts-of-data-cs.md)
[Next](creating-a-customized-sorting-user-interface-cs.md)</span></span>
