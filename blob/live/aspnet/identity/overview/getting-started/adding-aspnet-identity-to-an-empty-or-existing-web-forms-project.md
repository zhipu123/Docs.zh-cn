---
uid: identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
title: "添加 ASP.NET 标识设置为一个空的或现有的 Web 窗体项目 |Microsoft 文档"
author: raquelsa
description: "本教程演示如何将 ASP.NET 标识 （ASP.NET 的新成员资格系统） 添加到 ASP.NET 应用程序。 当你创建新的 Web 窗体或 MVC..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 10/23/2013
ms.topic: article
ms.assetid: 1cbc0ed2-5bd6-4b62-8d34-4c193dcd8b25
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project
msc.type: authoredcontent
ms.openlocfilehash: f5783287a26174ddf65bb0eae34c347831d02c47
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/10/2017
---
<a name="adding-aspnet-identity-to-an-empty-or-existing-web-forms-project"></a><span data-ttu-id="37b66-104">添加 ASP.NET 标识设置为一个空的或现有的 Web 窗体项目</span><span class="sxs-lookup"><span data-stu-id="37b66-104">Adding ASP.NET Identity to an Empty or Existing Web Forms Project</span></span>
====================
<span data-ttu-id="37b66-105">通过[Raquel Soares De Almeida](https://github.com/raquelsa)</span><span class="sxs-lookup"><span data-stu-id="37b66-105">by [Raquel Soares De Almeida](https://github.com/raquelsa)</span></span>

> <span data-ttu-id="37b66-106">本教程演示如何将添加[ASP.NET 标识](introduction-to-aspnet-identity.md)（ASP.NET 的新成员资格系统） 向 ASP.NET 应用程序。</span><span class="sxs-lookup"><span data-stu-id="37b66-106">This tutorial shows you how to add [ASP.NET Identity](introduction-to-aspnet-identity.md) (the new membership system for ASP.NET) to an ASP.NET application.</span></span>
> 
> <span data-ttu-id="37b66-107">当你在 Visual Studio 2013 RTM 与单个帐户中创建新的 Web 窗体或 MVC 项目时，Visual Studio 将安装所需的所有包，并为您添加所有必需的类。</span><span class="sxs-lookup"><span data-stu-id="37b66-107">When you create a new Web Forms or MVC project in Visual Studio 2013 RTM with Individual Accounts, Visual Studio will install all the required packages and add all necessary classes for you.</span></span> <span data-ttu-id="37b66-108">本教程将说明将 ASP.NET 身份验证支持添加到现有的 Web 窗体项目或新的空项目的步骤。</span><span class="sxs-lookup"><span data-stu-id="37b66-108">This tutorial will illustrate the steps to add ASP.NET Identity support to your existing Web Forms project or a new empty project.</span></span> <span data-ttu-id="37b66-109">我将概述了所有 NuGet 包，你需要安装，以及你需要添加的类。</span><span class="sxs-lookup"><span data-stu-id="37b66-109">I will outline all the NuGet packages you need to install, and classes you need to add.</span></span> <span data-ttu-id="37b66-110">注册新用户和登录时突出显示的用户管理和身份验证的所有主入口点 Api，我将会通过示例 Web 窗体。</span><span class="sxs-lookup"><span data-stu-id="37b66-110">I will go over sample Web Forms for registering new users and logging in while highlighting all main entry point APIs for user management and authentication.</span></span> <span data-ttu-id="37b66-111">此示例将用于 SQL 数据存储在实体框架上生成 ASP.NET 标识默认实现。</span><span class="sxs-lookup"><span data-stu-id="37b66-111">This sample will use the ASP.NET Identity default implementation for SQL data storage which is built on Entity Framework.</span></span> <span data-ttu-id="37b66-112">本教程中，我们将使用 LocalDB 的 SQL 数据库。</span><span class="sxs-lookup"><span data-stu-id="37b66-112">This tutorial, we will use LocalDB for the SQL database.</span></span>
> 
> <span data-ttu-id="37b66-113">本教程已写入 Raquel Soares De Almeida 和 Rick Anderson ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) )。</span><span class="sxs-lookup"><span data-stu-id="37b66-113">This tutorial was written by Raquel Soares De Almeida and Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ).</span></span>


## <a name="getting-started-aspnet-identity"></a><span data-ttu-id="37b66-114">入门 ASP.NET 标识</span><span class="sxs-lookup"><span data-stu-id="37b66-114">Getting Started ASP.NET Identity</span></span>

1. <span data-ttu-id="37b66-115">首先，安装并运行[Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058)或[Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566)。</span><span class="sxs-lookup"><span data-stu-id="37b66-115">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span>
2. <span data-ttu-id="37b66-116">单击**新项目**从一开始页上，您可以使用菜单并选择**文件**，，然后**新项目**。</span><span class="sxs-lookup"><span data-stu-id="37b66-116">Click **New Project** from the Start page, or you can use the menu and select **File**, and then **New Project**.</span></span>
3. <span data-ttu-id="37b66-117">选择**Visual C# i** n 左窗格中，然后**Web** ，然后选择**ASP.NET Web 应用程序**。</span><span class="sxs-lookup"><span data-stu-id="37b66-117">Select **Visual C# i** n the left pane, then **Web** and then select **ASP.NET Web Application**.</span></span> <span data-ttu-id="37b66-118">将你的项目"WebFormsIdentity"，然后单击**确定**。</span><span class="sxs-lookup"><span data-stu-id="37b66-118">Name your project "WebFormsIdentity" and then click **OK**.</span></span>   
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image1.png)
4. <span data-ttu-id="37b66-119">在**新建 ASP.NET 项目**对话框中，选择**空**模板。</span><span class="sxs-lookup"><span data-stu-id="37b66-119">In the **New ASP.NET Project** dialog, select the **Empty** template.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image2.png)  
  
 <span data-ttu-id="37b66-120">请注意**更改身份验证**按钮处于禁用状态和无身份验证支持提供此模板中。</span><span class="sxs-lookup"><span data-stu-id="37b66-120">Notice the **Change Authentication** button is disabled and no authentication support is provided in this template.</span></span> <span data-ttu-id="37b66-121">Web 窗体、 MVC 和 Web API 模板允许您选择的身份验证方法。</span><span class="sxs-lookup"><span data-stu-id="37b66-121">The Web Forms, MVC and Web API templates allow you to select the authentication approach.</span></span> <span data-ttu-id="37b66-122">有关详细信息，请参阅[的身份验证概述](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth)。</span><span class="sxs-lookup"><span data-stu-id="37b66-122">For more information, see [Overview of Authentication](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth) .</span></span>

## <a name="adding-identity-packages-to-your-app"></a><span data-ttu-id="37b66-123">将标识包添加到你的应用程序</span><span class="sxs-lookup"><span data-stu-id="37b66-123">Adding Identity Packages to your App</span></span>

<span data-ttu-id="37b66-124">在解决方案资源管理器，右键单击你的项目，然后选择**管理 NuGet 包**。</span><span class="sxs-lookup"><span data-stu-id="37b66-124">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="37b66-125">在搜索文本框对话框中，键入"*Identity.E*"。</span><span class="sxs-lookup"><span data-stu-id="37b66-125">In the search text box dialog, type "*Identity.E*".</span></span> <span data-ttu-id="37b66-126">单击安装此包。</span><span class="sxs-lookup"><span data-stu-id="37b66-126">Click install for this package.</span></span>   
  
![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image3.png)  
  
<span data-ttu-id="37b66-127">请注意，此包将安装依赖项包： EntityFramework 和 Microsoft ASP.NET Identity Core。</span><span class="sxs-lookup"><span data-stu-id="37b66-127">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span>

## <a name="adding-web-forms-to-register-users"></a><span data-ttu-id="37b66-128">添加 Web 窗体来注册用户</span><span class="sxs-lookup"><span data-stu-id="37b66-128">Adding Web Forms to Register Users</span></span>

1. <span data-ttu-id="37b66-129">在**解决方案资源管理器**，右键单击你的项目，然后单击**添加**，，然后**Web 窗体**。</span><span class="sxs-lookup"><span data-stu-id="37b66-129">In **Solution Explorer**, right-click your project and click **Add**, and then **Web Form**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image4.png)
2. <span data-ttu-id="37b66-130">在**指定项名称**对话框中，命名新的 web 窗体**注册**，然后单击**确定**</span><span class="sxs-lookup"><span data-stu-id="37b66-130">In the **Specify Name for Item** dialog box, name the new web form **Register**, and then click **OK**</span></span>
3. <span data-ttu-id="37b66-131">将在生成标记*Register.aspx*文件替换为以下代码。</span><span class="sxs-lookup"><span data-stu-id="37b66-131">Replace the markup in the generated *Register.aspx* file with the code below.</span></span> <span data-ttu-id="37b66-132">突出显示代码更改。</span><span class="sxs-lookup"><span data-stu-id="37b66-132">The code changes are highlighted.</span></span>   

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample1.aspx?highlight=9,12-40)]

    > [!NOTE]
    > <span data-ttu-id="37b66-133">这是仅的简化的版本*Register.aspx*创建一个新的 ASP.NET Web 窗体项目时创建的文件。</span><span class="sxs-lookup"><span data-stu-id="37b66-133">This is just a simplified version of the *Register.aspx* file that is created when you create a new ASP.NET Web Forms project.</span></span> <span data-ttu-id="37b66-134">上面的标记添加窗体字段和一个按钮以注册新的用户。</span><span class="sxs-lookup"><span data-stu-id="37b66-134">The markup above adds form fields and a button to register a new user.</span></span>
4. <span data-ttu-id="37b66-135">打开*Register.aspx.cs*文件并将文件的内容替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="37b66-135">Open the *Register.aspx.cs* file and replace the contents of the file with the following code:</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample2.cs)]

    > [!NOTE] 
    > 
    > 1. <span data-ttu-id="37b66-136">上面的代码是的简化的版本*Register.aspx.cs*创建一个新的 ASP.NET Web 窗体项目时创建的文件。</span><span class="sxs-lookup"><span data-stu-id="37b66-136">The code above is a simplified version of the *Register.aspx.cs* file that is created when you create a new ASP.NET Web Forms project.</span></span>
    > 2. <span data-ttu-id="37b66-137">*IdentityUser*类是默认 EntityFramework 实现*IUser*接口。</span><span class="sxs-lookup"><span data-stu-id="37b66-137">The *IdentityUser* class is the default EntityFramework implementation of the *IUser* interface.</span></span> <span data-ttu-id="37b66-138">*IUser*接口是 ASP.NET Identity Core 上的用户的最小接口。</span><span class="sxs-lookup"><span data-stu-id="37b66-138">*IUser* interface is the minimal interface for a user on ASP.NET Identity Core.</span></span>
    > 3. <span data-ttu-id="37b66-139">*UserStore*类是用户存储的默认 EntityFramework 实现。</span><span class="sxs-lookup"><span data-stu-id="37b66-139">The *UserStore* class is the default EntityFramework implementation of a user store.</span></span> <span data-ttu-id="37b66-140">此类实现 ASP.NET Identity Core 的最小接口： *IUserStore*， *IUserLoginStore*， *IUserClaimStore*和*IUserRoleStore*.</span><span class="sxs-lookup"><span data-stu-id="37b66-140">This class implements the ASP.NET Identity Core's minimal interfaces: *IUserStore*, *IUserLoginStore*, *IUserClaimStore* and *IUserRoleStore*.</span></span>
    > 4. <span data-ttu-id="37b66-141">*UserManager*与类公开用户相关的 Api 将自动将其保存到的更改*UserStore*。</span><span class="sxs-lookup"><span data-stu-id="37b66-141">The *UserManager* class exposes user related APIs which will automatically save changes to the *UserStore*.</span></span>
    > 5. <span data-ttu-id="37b66-142">*IdentityResult*类表示标识操作的结果。</span><span class="sxs-lookup"><span data-stu-id="37b66-142">The *IdentityResult* class represents the result of an identity operation.</span></span>
5. <span data-ttu-id="37b66-143">在**解决方案资源管理器**，右键单击你的项目，然后单击**添加**，**添加 ASP.NET 文件夹**然后**应用\_数据**。</span><span class="sxs-lookup"><span data-stu-id="37b66-143">In **Solution Explorer**, right-click your project and click **Add**, **Add ASP.NET Folder** and then **App\_Data**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image5.png)
6. <span data-ttu-id="37b66-144">打开*Web.config*文件并添加我们将用来存储用户信息的数据库的连接字符串条目。</span><span class="sxs-lookup"><span data-stu-id="37b66-144">Open the *Web.config* file and add a connection string entry for the database we will use to store user information.</span></span> <span data-ttu-id="37b66-145">数据库将在运行时通过 EntityFramework 为创建标识实体。</span><span class="sxs-lookup"><span data-stu-id="37b66-145">The database will be created at runtime by EntityFramework for the Identity entities.</span></span> <span data-ttu-id="37b66-146">连接字符串是类似于在创建新的 Web 窗体项目时，为你创建的。</span><span class="sxs-lookup"><span data-stu-id="37b66-146">The connection string is similar to one created for you when you create a new Web Forms project.</span></span> <span data-ttu-id="37b66-147">突出显示的代码演示了应添加的标记：</span><span class="sxs-lookup"><span data-stu-id="37b66-147">The highlighted code shows the markup you should add:</span></span>

    [!code-xml[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample3.xml?highlight=11-14)]
    
    > [!NOTE] 
    > <span data-ttu-id="37b66-148">有关 Visual Studio 2015 或更高版本，则替换`(localdb)\v11.0`与`(localdb)\MSSQLLocalDB`连接字符串中。</span><span class="sxs-lookup"><span data-stu-id="37b66-148">For Visual Studio 2015 or higher, replace `(localdb)\v11.0` with `(localdb)\MSSQLLocalDB` in your connection string.</span></span>
    
7. <span data-ttu-id="37b66-149">右键单击文件*Register.aspx*中你的项目并选择**设为起始页**。</span><span class="sxs-lookup"><span data-stu-id="37b66-149">Right click file *Register.aspx* in your project and select **Set as Start Page**.</span></span> <span data-ttu-id="37b66-150">按 Ctrl + F5 生成并运行 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="37b66-150">Press Ctrl + F5 to build and run the web application.</span></span> <span data-ttu-id="37b66-151">输入新的用户名和密码，然后单击**注册**。</span><span class="sxs-lookup"><span data-stu-id="37b66-151">Enter a new user name and password and then click on **Register**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image6.png)  

    > [!NOTE]
    > <span data-ttu-id="37b66-152">ASP.NET 标识具有对验证的支持，在此示例中，你可以验证用户和密码的默认行为来自标识核心包的验证程序。</span><span class="sxs-lookup"><span data-stu-id="37b66-152">ASP.NET Identity has support for validation and in this sample you can verify the default behavior on User and Password validators that come from the Identity Core package.</span></span> <span data-ttu-id="37b66-153">用户的默认验证 (`UserValidator`) 都有一个属性`AllowOnlyAlphanumericUserNames`，其默认值设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="37b66-153">The default validator for User (`UserValidator`) has a property `AllowOnlyAlphanumericUserNames` that has default value set to `true`.</span></span> <span data-ttu-id="37b66-154">密码的默认验证 (`MinimumLengthValidator`) 可确保该密码具有至少 6 个字符。</span><span class="sxs-lookup"><span data-stu-id="37b66-154">The default validator for Password (`MinimumLengthValidator`) ensures that password has at least 6 characters.</span></span> <span data-ttu-id="37b66-155">这些验证程序属性位于`UserManager`，如果你想要自定义验证，可以重写</span><span class="sxs-lookup"><span data-stu-id="37b66-155">These validators are properties on `UserManager` that can be overridden if you want to have custom validation,</span></span>

## <a name="verifying-the-localdb-identity-database-and-tables-generated-by-entity-framework"></a><span data-ttu-id="37b66-156">验证 LocalDb 标识数据库和表由实体框架生成</span><span class="sxs-lookup"><span data-stu-id="37b66-156">Verifying the LocalDb Identity Database and Tables Generated by Entity Framework</span></span>

1. <span data-ttu-id="37b66-157">在**视图**菜单上，单击**服务器资源管理器**。</span><span class="sxs-lookup"><span data-stu-id="37b66-157">In the **View** menu, click **Server Explorer**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image7.png)
2. <span data-ttu-id="37b66-158">展开**DefaultConnection (WebFormsIdentity)**，展开**表**，右键单击**AspNetUsers**单击**显示表数据**。</span><span class="sxs-lookup"><span data-stu-id="37b66-158">Expand **DefaultConnection (WebFormsIdentity)**, expand **Tables**, right click **AspNetUsers** and click **Show Table Data**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image8.png)  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image9.png)

## <a name="configuring-the-application-for-owin-authentication"></a><span data-ttu-id="37b66-159">OWIN 身份验证的应用程序配置</span><span class="sxs-lookup"><span data-stu-id="37b66-159">Configuring the application for OWIN authentication</span></span>

<span data-ttu-id="37b66-160">此时我们仅添加了支持用于创建用户。</span><span class="sxs-lookup"><span data-stu-id="37b66-160">At this point we have only added support for creating users.</span></span> <span data-ttu-id="37b66-161">现在，我们将演示，我们可以如何添加身份验证登录用户。</span><span class="sxs-lookup"><span data-stu-id="37b66-161">Now, we are going to demonstrate how we can add authentication to login a user.</span></span> <span data-ttu-id="37b66-162">ASP.NET 标识用于表单身份验证使用 Microsoft OWIN 身份验证中间件。</span><span class="sxs-lookup"><span data-stu-id="37b66-162">ASP.NET Identity uses Microsoft OWIN Authentication middleware for forms authentication.</span></span> <span data-ttu-id="37b66-163">OWIN Cookie 身份验证是 cookie 和声明可由任何框架上托管的基于身份验证机制[OWIN](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx)或 IIS。</span><span class="sxs-lookup"><span data-stu-id="37b66-163">The OWIN Cookie Authentication is a cookie and claims based authentication mechanism that can be used by any framework hosted on [OWIN](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx) or IIS.</span></span> <span data-ttu-id="37b66-164">与此模型中，可以跨多个框架，包括 ASP.NET MVC 和 Web 窗体使用相同的身份验证包。</span><span class="sxs-lookup"><span data-stu-id="37b66-164">With this model, the same authentication packages can be used across multiple frameworks including ASP.NET MVC and Web Forms.</span></span> <span data-ttu-id="37b66-165">有关详细信息项目 Katana 以及如何运行主机不可知，请参阅中的中间件[Getting Started with Katana 项目](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx)。</span><span class="sxs-lookup"><span data-stu-id="37b66-165">For more information on project Katana and how to run middleware in a host agnostic see [Getting Started with the Katana Project](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx).</span></span>

## <a name="installing-authentication-packages-to-your-application"></a><span data-ttu-id="37b66-166">将身份验证程序包安装到你的应用程序</span><span class="sxs-lookup"><span data-stu-id="37b66-166">Installing authentication packages to your application</span></span>

1. <span data-ttu-id="37b66-167">在解决方案资源管理器，右键单击你的项目，然后选择**管理 NuGet 包**。</span><span class="sxs-lookup"><span data-stu-id="37b66-167">In Solution Explorer, right-click your project and select **Manage NuGet Packages**.</span></span> <span data-ttu-id="37b66-168">在搜索文本框对话框中，键入"*Identity.Owin*"。</span><span class="sxs-lookup"><span data-stu-id="37b66-168">In the search text box dialog, type "*Identity.Owin*".</span></span> <span data-ttu-id="37b66-169">单击安装此包。</span><span class="sxs-lookup"><span data-stu-id="37b66-169">Click install for this package.</span></span>   
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image10.png)
2. <span data-ttu-id="37b66-170">搜索包***Microsoft.Owin.Host.SystemWeb***并将其安装。</span><span class="sxs-lookup"><span data-stu-id="37b66-170">Search for package ***Microsoft.Owin.Host.SystemWeb*** and install it.</span></span>   

    > [!NOTE]
    > <span data-ttu-id="37b66-171">**Microsoft.Aspnet.Identity.Owin**包包含 OWIN 扩展类，用于管理和配置 OWIN 身份验证中间件将使用 ASP.NET 标识核心包的一组。</span><span class="sxs-lookup"><span data-stu-id="37b66-171">The **Microsoft.Aspnet.Identity.Owin** package contains a set of OWIN extension classes to manage and configure OWIN authentication middleware to be consumed by ASP.NET Identity Core packages.</span></span>  
    > <span data-ttu-id="37b66-172">**Microsoft.Owin.Host.SystemWeb**包包含使基于 OWIN 的应用程序可以在使用 ASP.NET 请求管道的 IIS 上运行的 OWIN 服务器。</span><span class="sxs-lookup"><span data-stu-id="37b66-172">The **Microsoft.Owin.Host.SystemWeb** package contains an OWIN server that enables OWIN-based applications to run on IIS using the ASP.NET request pipeline.</span></span> <span data-ttu-id="37b66-173">有关详细信息请参阅[在 IIS 中的 OWIN 中间件集成管道](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md)。</span><span class="sxs-lookup"><span data-stu-id="37b66-173">For more information see [OWIN Middleware in the IIS integrated pipeline](../../../aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline.md).</span></span>

## <a name="adding-owin-startup-and-authentication-configuration-classes"></a><span data-ttu-id="37b66-174">添加 OWIN 启动和身份验证配置类</span><span class="sxs-lookup"><span data-stu-id="37b66-174">Adding OWIN Startup and Authentication Configuration Classes</span></span>

1. <span data-ttu-id="37b66-175">在**解决方案资源管理器**，右键单击你的项目，单击**添加**，，然后**添加新项**。</span><span class="sxs-lookup"><span data-stu-id="37b66-175">In **Solution Explorer**, right-click your project, click **Add**, and then **Add New Item**.</span></span> <span data-ttu-id="37b66-176">在搜索文本框对话框中，键入"*owin*"。</span><span class="sxs-lookup"><span data-stu-id="37b66-176">In the search text box dialog, type "*owin*".</span></span> <span data-ttu-id="37b66-177">将类"*启动*"，然后单击**添加**。</span><span class="sxs-lookup"><span data-stu-id="37b66-177">Name the class "*Startup*" and click **Add**.</span></span>   
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image11.png)
2. <span data-ttu-id="37b66-178">在 Startup.cs 文件中，添加突出显示的代码下面显示配置 OWIN cookie 身份验证。</span><span class="sxs-lookup"><span data-stu-id="37b66-178">In the Startup.cs file, add the highlighted code shown below to configure OWIN cookie authentication.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample4.cs?highlight=1,3,15-19)]

    > [!NOTE]
    > <span data-ttu-id="37b66-179">此类包含`OwinStartup`指定 OWIN 启动类的属性。</span><span class="sxs-lookup"><span data-stu-id="37b66-179">This class contains the `OwinStartup` attribute for specifying the OWIN startup class.</span></span> <span data-ttu-id="37b66-180">每个 OWIN 应用程序具有一个 startup 类，其中您可以指定应用程序管道的组件。</span><span class="sxs-lookup"><span data-stu-id="37b66-180">Every OWIN application has a startup class where you specify components for the application pipeline.</span></span> <span data-ttu-id="37b66-181">请参阅[OWIN 启动类检测](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md)有关此模型的详细信息。</span><span class="sxs-lookup"><span data-stu-id="37b66-181">See [OWIN Startup Class Detection](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) for more info on this model.</span></span>

## <a name="adding-web-forms-for-registering-and-logging-in-users"></a><span data-ttu-id="37b66-182">添加用于注册和登录用户的 Web 窗体</span><span class="sxs-lookup"><span data-stu-id="37b66-182">Adding Web Forms for Registering and Logging in Users</span></span>

1. <span data-ttu-id="37b66-183">打开*Register.cs*文件并添加以下代码以将时的登录用户注册成功。</span><span class="sxs-lookup"><span data-stu-id="37b66-183">Open the *Register.cs* file and add the following code which will log in the user when registration succeeds.</span></span> <span data-ttu-id="37b66-184">下面突出显示所做的更改。</span><span class="sxs-lookup"><span data-stu-id="37b66-184">The changes are highlighted below.</span></span>

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample5.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="37b66-185">ASP.NET 标识和 OWIN Cookie 身份验证是基于声明的系统事件，因为框架需要应用程序开发人员生成[ClaimsIdentity](https://msdn.microsoft.com/en-us/library/microsoft.identitymodel.claims.claimsidentity.aspx)用户。</span><span class="sxs-lookup"><span data-stu-id="37b66-185">Since ASP.NET Identity and OWIN Cookie Authentication are claims based system, the framework requires the app developer to generate a [ClaimsIdentity](https://msdn.microsoft.com/en-us/library/microsoft.identitymodel.claims.claimsidentity.aspx) for the user.</span></span> <span data-ttu-id="37b66-186">ClaimsIdentity 具有的用户属于哪些角色如用户的所有声明的信息。</span><span class="sxs-lookup"><span data-stu-id="37b66-186">ClaimsIdentity has information about all the claims for the user such as what Roles the user belongs to.</span></span> <span data-ttu-id="37b66-187">在此阶段，你还可以添加用户的多个的声明。</span><span class="sxs-lookup"><span data-stu-id="37b66-187">You can also add more claims for the user at this stage.</span></span>
    > - <span data-ttu-id="37b66-188">你可以在登录用户通过使用从 OWIN 和调用 AuthenticationManager`SignIn`并传入 ClaimsIdentity 如上所示。</span><span class="sxs-lookup"><span data-stu-id="37b66-188">You can sign in the user by using the AuthenticationManager from OWIN and calling `SignIn` and passing in the ClaimsIdentity as shown above.</span></span> <span data-ttu-id="37b66-189">此代码将在用户登录，并生成一个 cookie 以及。</span><span class="sxs-lookup"><span data-stu-id="37b66-189">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="37b66-190">此调用是类似于[FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthentication.setauthcookie.aspx)由[FormsAuthentication](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthenticationmodule.aspx)模块。</span><span class="sxs-lookup"><span data-stu-id="37b66-190">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
2. <span data-ttu-id="37b66-191">在**解决方案资源管理器**，右键单击项目单击**添加**，，然后**Web 窗体**。</span><span class="sxs-lookup"><span data-stu-id="37b66-191">In **Solution Explorer**, right-click your project click **Add**, and then **Web Form**.</span></span> <span data-ttu-id="37b66-192">将 web 窗体**登录**。</span><span class="sxs-lookup"><span data-stu-id="37b66-192">Name the web form **Login**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image12.png)
3. <span data-ttu-id="37b66-193">内容替换*Login.aspx*文件替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="37b66-193">Replace the contents of the *Login.aspx* file with the following code:</span></span>  

    [!code-aspx[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample6.aspx)]
4. <span data-ttu-id="37b66-194">内容替换*Login.aspx.cs*替换为以下文件：</span><span class="sxs-lookup"><span data-stu-id="37b66-194">Replace the contents of the *Login.aspx.cs* file with the following:</span></span>  

    [!code-csharp[Main](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/samples/sample7.cs)]

    > [!NOTE] 
    > 
    > - <span data-ttu-id="37b66-195">`Page_Load`现在检查当前用户的状态并可采取措施基于其`Context.User.Identity.IsAuthenticated`状态。</span><span class="sxs-lookup"><span data-stu-id="37b66-195">The `Page_Load` now checks for the status of current user and takes action based on its `Context.User.Identity.IsAuthenticated` status.</span></span>  
    >     <span data-ttu-id="37b66-196">**在用户名中显示已登录**： 的 Microsoft ASP.NET Identity Framework 已添加的扩展方法上, [System.Security.Principal.IIdentity](https://msdn.microsoft.com/en-us/library/system.security.principal.iidentity.aspx) ，使你能获取`UserName`和`UserId`为在已登录的用户。</span><span class="sxs-lookup"><span data-stu-id="37b66-196">**Display Logged in User Name** : The Microsoft ASP.NET Identity Framework has added extension methods on [System.Security.Principal.IIdentity](https://msdn.microsoft.com/en-us/library/system.security.principal.iidentity.aspx) that allows you to get the `UserName` and `UserId`  for the logged in User.</span></span> <span data-ttu-id="37b66-197">这些扩展方法定义中`Microsoft.AspNet.Identity.Core`程序集。</span><span class="sxs-lookup"><span data-stu-id="37b66-197">These extension methods are defined in the `Microsoft.AspNet.Identity.Core` assembly.</span></span> <span data-ttu-id="37b66-198">这些扩展方法是为替换[HttpContext.User.Identity.Name](https://msdn.microsoft.com/en-us/library/system.web.httpcontext.user.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="37b66-198">These extension methods are the replacement for [HttpContext.User.Identity.Name](https://msdn.microsoft.com/en-us/library/system.web.httpcontext.user.aspx) .</span></span>
    > - <span data-ttu-id="37b66-199">登录方法：</span><span class="sxs-lookup"><span data-stu-id="37b66-199">SignIn method:</span></span>   
    >     <span data-ttu-id="37b66-200">`This`方法取代了以前`CreateUser_Click`在此示例和现在登录已成功创建用户之后用户的方法。</span><span class="sxs-lookup"><span data-stu-id="37b66-200">`This` method replaces the previous `CreateUser_Click` method in this sample and now signs in the user after successfully creating the user.</span></span>   
    >  <span data-ttu-id="37b66-201">Microsoft OWIN Framework 已添加的扩展方法上, `System.Web.HttpContext` ，你能够获取对引用`IOwinContext`。</span><span class="sxs-lookup"><span data-stu-id="37b66-201">The Microsoft OWIN Framework has added extension methods on `System.Web.HttpContext` that allows you to get a reference to an `IOwinContext`.</span></span> <span data-ttu-id="37b66-202">这些扩展方法定义中`Microsoft.Owin.Host.SystemWeb`程序集。</span><span class="sxs-lookup"><span data-stu-id="37b66-202">These extension methods are defined in `Microsoft.Owin.Host.SystemWeb` assembly.</span></span> <span data-ttu-id="37b66-203">`OwinContext`类会公开`IAuthenticationManager`表示可对当前请求的身份验证中间件功能的属性。</span><span class="sxs-lookup"><span data-stu-id="37b66-203">The `OwinContext` class exposes an `IAuthenticationManager` property that represents the Authentication middleware functionality available on the current request.</span></span>  
    >  <span data-ttu-id="37b66-204">可以通过使用来在用户登录`AuthenticationManager`从 OWIN 和调用`SignIn`和传入`ClaimsIdentity`如上所示。</span><span class="sxs-lookup"><span data-stu-id="37b66-204">You can sign in the user by using the `AuthenticationManager` from OWIN and calling `SignIn`  and passing in the `ClaimsIdentity`  as shown above.</span></span>   
    >  <span data-ttu-id="37b66-205">因为 ASP.NET 标识和 OWIN Cookie 身份验证是基于声明的系统，框架需要应用程序生成`ClaimsIdentity`用户。</span><span class="sxs-lookup"><span data-stu-id="37b66-205">Because ASP.NET Identity and OWIN Cookie Authentication are claims-based system, the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span>   
    >  <span data-ttu-id="37b66-206">`ClaimsIdentity`具有的用户，如用户所属的角色的所有声明的信息。</span><span class="sxs-lookup"><span data-stu-id="37b66-206">The `ClaimsIdentity` has information about all the claims for the user, such as what roles the user belongs to.</span></span> <span data-ttu-id="37b66-207">你还可以在此阶段添加用户的多个的声明</span><span class="sxs-lookup"><span data-stu-id="37b66-207">You can also add more claims for the user at this stage</span></span>  
    >  <span data-ttu-id="37b66-208">此代码将在用户登录，并生成一个 cookie 以及。</span><span class="sxs-lookup"><span data-stu-id="37b66-208">This code will sign in the user and generate a cookie as well.</span></span> <span data-ttu-id="37b66-209">此调用是类似于[FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthentication.setauthcookie.aspx)由[FormsAuthentication](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthenticationmodule.aspx)模块。</span><span class="sxs-lookup"><span data-stu-id="37b66-209">This call is analogous to [FormAuthentication.SetAuthCookie](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthentication.setauthcookie.aspx) used by the [FormsAuthentication](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
    > - <span data-ttu-id="37b66-210">`SignOut`方法：</span><span class="sxs-lookup"><span data-stu-id="37b66-210">`SignOut` method:</span></span>   
    >  <span data-ttu-id="37b66-211">获取对`AuthenticationManager`从 OWIN 和调用`SignOut`。</span><span class="sxs-lookup"><span data-stu-id="37b66-211">Gets a reference to the `AuthenticationManager` from OWIN and calls `SignOut`.</span></span> <span data-ttu-id="37b66-212">这是类似于[FormsAuthentication.SignOut](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthentication.signout.aspx)方法，由[FormsAuthentication](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthenticationmodule.aspx)模块。</span><span class="sxs-lookup"><span data-stu-id="37b66-212">This is analogous to [FormsAuthentication.SignOut](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthentication.signout.aspx) method used by the [FormsAuthentication](https://msdn.microsoft.com/en-us/library/system.web.security.formsauthenticationmodule.aspx) module.</span></span>
5. <span data-ttu-id="37b66-213">按**Ctrl + F5**生成并运行 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="37b66-213">Press **Ctrl + F5** to build and run the web application.</span></span> <span data-ttu-id="37b66-214">输入新的用户名和密码，然后单击**注册**。</span><span class="sxs-lookup"><span data-stu-id="37b66-214">Enter a new user name and password and then click on **Register**.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image13.png)  
 <span data-ttu-id="37b66-215">注意： 此时，新用户创建并登录。</span><span class="sxs-lookup"><span data-stu-id="37b66-215">Note: At this point, the new user is created and logged in.</span></span>
6. <span data-ttu-id="37b66-216">单击**注销**按钮。你将重定向到窗体中的日志。</span><span class="sxs-lookup"><span data-stu-id="37b66-216">Click on **Log out** button.You will be redirected to the Log in form.</span></span>
7. <span data-ttu-id="37b66-217">输入无效的用户名称或密码，然后单击上**登录**按钮。</span><span class="sxs-lookup"><span data-stu-id="37b66-217">Enter an invalid user name or password and Click on **Log in** button.</span></span>   
 <span data-ttu-id="37b66-218">`UserManager.Find`方法将返回 null 和错误消息:"*无效的用户名或密码*"将显示。</span><span class="sxs-lookup"><span data-stu-id="37b66-218">The `UserManager.Find`  method will return null and the error message: " *Invalid user name or password* " will be displayed.</span></span>  
  
    ![](adding-aspnet-identity-to-an-empty-or-existing-web-forms-project/_static/image14.png)
