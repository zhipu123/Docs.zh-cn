---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: "从 SQL 成员资格的现有网站迁移到 ASP.NET 标识 |Microsoft 文档"
author: Rick-Anderson
description: "本教程说明了将迁移用户和角色数据创建使用 SQL 成员资格为新的 ASP.NET 标识 s 的现有 web 应用程序的步骤..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/19/2014
ms.topic: article
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: b88cd54040c02c977a83e20d7af7fda4fff969c1
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/10/2017
---
<a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="c68d5-103">从 SQL 成员资格的现有网站迁移到 ASP.NET 标识</span><span class="sxs-lookup"><span data-stu-id="c68d5-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>
====================
<span data-ttu-id="c68d5-104">通过[Rick Anderson](https://github.com/Rick-Anderson)， [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="c68d5-104">by [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="c68d5-105">本教程说明了将迁移用户和角色数据到新的 ASP.NET 标识系统中使用 SQL 成员身份创建的现有 web 应用程序的步骤。</span><span class="sxs-lookup"><span data-stu-id="c68d5-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="c68d5-106">此方法涉及将现有的数据库架构更改为一个所需的 ASP.NET 标识和挂钩陷入到它的新旧/类。</span><span class="sxs-lookup"><span data-stu-id="c68d5-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="c68d5-107">迁移你的数据库后，采用此方法后，将可轻松处理标识的未来更新。</span><span class="sxs-lookup"><span data-stu-id="c68d5-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>


<span data-ttu-id="c68d5-108">对于本教程中，我们将采用使用 Visual Studio 2010 创建用户和角色的数据创建的 web 应用程序模板 （Web 窗体）。</span><span class="sxs-lookup"><span data-stu-id="c68d5-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="c68d5-109">然后，我们将使用 SQL 脚本以将现有数据库迁移到所需的标识系统的表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="c68d5-110">接下来，我们将安装所需的 NuGet 包并添加新帐户管理页用于成员资格管理的标识系统使用它们。</span><span class="sxs-lookup"><span data-stu-id="c68d5-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="c68d5-111">为迁移的测试，创建使用 SQL 成员身份的用户应该能够登录和新用户应该能够注册。</span><span class="sxs-lookup"><span data-stu-id="c68d5-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="c68d5-112">你可以找到完整的示例[此处](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/)。</span><span class="sxs-lookup"><span data-stu-id="c68d5-112">You can find the complete sample [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="c68d5-113">另请参阅[从 ASP.NET 成员资格迁移到 ASP.NET 标识](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html)。</span><span class="sxs-lookup"><span data-stu-id="c68d5-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="c68d5-114">入门</span><span class="sxs-lookup"><span data-stu-id="c68d5-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="c68d5-115">使用 SQL 成员身份创建应用程序</span><span class="sxs-lookup"><span data-stu-id="c68d5-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="c68d5-116">我们需要以开头的现有应用程序使用 SQL 成员资格，并且有用户和角色的数据。</span><span class="sxs-lookup"><span data-stu-id="c68d5-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="c68d5-117">本文中，为了让我们在 Visual Studio 2010 中创建 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="c68d5-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="c68d5-118">使用 ASP.NET 配置工具中，创建 2 个用户： **oldAdminUser**和**oldUser。**</span><span class="sxs-lookup"><span data-stu-id="c68d5-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="c68d5-119">创建一个名为管理员角色并为该角色中的用户添加 oldAdminUser。</span><span class="sxs-lookup"><span data-stu-id="c68d5-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="c68d5-120">使用 Default.aspx 创建站点的管理部分。</span><span class="sxs-lookup"><span data-stu-id="c68d5-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="c68d5-121">在 web.config 文件以启用访问仅向管理员角色中的用户设置的授权标记。</span><span class="sxs-lookup"><span data-stu-id="c68d5-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="c68d5-122">详细信息可在此处找到[https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="c68d5-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="c68d5-123">查看数据库在服务器资源管理器，以了解 SQL 成员资格系统所创建的表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="c68d5-124">用户登录名数据存储在 aspnet\_用户和 aspnet\_成员资格表，而角色数据存储在 aspnet\_Roles 表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="c68d5-125">用户所在哪些角色存储在 aspnet 信息\_UsersInRoles 表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="c68d5-126">对于基本成员资格管理它已足够移植到 ASP.NET 标识系统上述表中的信息。</span><span class="sxs-lookup"><span data-stu-id="c68d5-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="c68d5-127">迁移到 Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="c68d5-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="c68d5-128">安装 Visual Studio Express 2013 for Web 或 Visual Studio 2013 沿[最新的更新](https://www.microsoft.com/en-us/download/details.aspx?id=44921)。</span><span class="sxs-lookup"><span data-stu-id="c68d5-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/en-us/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="c68d5-129">在你安装的 Visual Studio 版本中打开上述项目。</span><span class="sxs-lookup"><span data-stu-id="c68d5-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="c68d5-130">如果在计算机上未安装 SQL Server Express，当你打开项目，因为该连接字符串使用 SQL Express 时被显示一条提示。</span><span class="sxs-lookup"><span data-stu-id="c68d5-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="c68d5-131">你可以选择要安装 SQL Express 或作为变通解决更改 LocalDb 的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="c68d5-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="c68d5-132">此文章我们会将其更改为 LocalDb。</span><span class="sxs-lookup"><span data-stu-id="c68d5-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="c68d5-133">打开 web.config 并更改中的连接字符串。到 (LocalDb) v11.0 SQLExpess。</span><span class="sxs-lookup"><span data-stu-id="c68d5-133">Open web.config and change the connection string from .SQLExpess to (LocalDb)v11.0.</span></span> <span data-ttu-id="c68d5-134">删除用户实例 = true 从连接字符串。</span><span class="sxs-lookup"><span data-stu-id="c68d5-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="c68d5-135">打开服务器资源管理器并验证可以观察的表架构和数据。</span><span class="sxs-lookup"><span data-stu-id="c68d5-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="c68d5-136">ASP.NET 标识系统适用于 4.5 或更高版本的 framework 版本。</span><span class="sxs-lookup"><span data-stu-id="c68d5-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="c68d5-137">重定目标为 4.5 或更高版本的应用程序。</span><span class="sxs-lookup"><span data-stu-id="c68d5-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="c68d5-138">生成项目，以验证有任何错误。</span><span class="sxs-lookup"><span data-stu-id="c68d5-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="c68d5-139">正在安装 Nuget 包</span><span class="sxs-lookup"><span data-stu-id="c68d5-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="c68d5-140">在解决方案资源管理器，右键单击项目&gt;**管理 NuGet 包**。</span><span class="sxs-lookup"><span data-stu-id="c68d5-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="c68d5-141">在搜索框中，输入"Asp.net 标识"。</span><span class="sxs-lookup"><span data-stu-id="c68d5-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="c68d5-142">在结果列表中选择的包，然后单击安装。</span><span class="sxs-lookup"><span data-stu-id="c68d5-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="c68d5-143">通过单击"我接受"按钮接受许可协议。</span><span class="sxs-lookup"><span data-stu-id="c68d5-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="c68d5-144">请注意，此包将安装依赖项包： EntityFramework 和 Microsoft ASP.NET Identity Core。</span><span class="sxs-lookup"><span data-stu-id="c68d5-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="c68d5-145">同样安装以下包 （如果你不想要启用 OAuth 登录，请跳过最后 4 OWIN 包）：</span><span class="sxs-lookup"><span data-stu-id="c68d5-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

    - <span data-ttu-id="c68d5-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="c68d5-146">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="c68d5-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="c68d5-147">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="c68d5-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="c68d5-148">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="c68d5-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="c68d5-149">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="c68d5-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="c68d5-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="c68d5-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="c68d5-151">Microsoft.Owin.Security.Twitter</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="c68d5-152">将数据库迁移到新的标识系统</span><span class="sxs-lookup"><span data-stu-id="c68d5-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="c68d5-153">下一步是将现有数据库迁移到由 ASP.NET 标识系统所需的架构。</span><span class="sxs-lookup"><span data-stu-id="c68d5-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="c68d5-154">若要实现此我们运行 SQL 脚本拥有一组命令以创建新表并将现有的用户信息迁移到新表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="c68d5-155">找不到脚本文件[此处](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql)。</span><span class="sxs-lookup"><span data-stu-id="c68d5-155">The script file can be found [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="c68d5-156">此脚本文件是特定于此示例。</span><span class="sxs-lookup"><span data-stu-id="c68d5-156">This script file is specific to this sample.</span></span> <span data-ttu-id="c68d5-157">如果创建的表的架构使用 SQL 成员资格自定义或修改脚本需要相应地更改。</span><span class="sxs-lookup"><span data-stu-id="c68d5-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="c68d5-158">如何生成架构迁移的 SQL 脚本</span><span class="sxs-lookup"><span data-stu-id="c68d5-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="c68d5-159">对于 ASP.NET 标识类的现有用户与数据现成工作，我们需要将数据库架构迁移到 ASP.NET 标识所需的一个。</span><span class="sxs-lookup"><span data-stu-id="c68d5-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="c68d5-160">我们可以通过添加新表并将现有的信息复制到这些表来执行此操作。</span><span class="sxs-lookup"><span data-stu-id="c68d5-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="c68d5-161">默认情况下 ASP.NET 标识使用 EntityFramework 将标识模型类映射到数据库来存储/检索信息。</span><span class="sxs-lookup"><span data-stu-id="c68d5-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="c68d5-162">这些模型类实现核心标识接口定义用户和角色对象。</span><span class="sxs-lookup"><span data-stu-id="c68d5-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="c68d5-163">表和数据库中的列基于这些模型类。</span><span class="sxs-lookup"><span data-stu-id="c68d5-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="c68d5-164">下面定义是标识 v2.1.0 和它们的属性中的 EntityFramework 模型类</span><span class="sxs-lookup"><span data-stu-id="c68d5-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="c68d5-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="c68d5-165">**IdentityUser**</span></span> | <span data-ttu-id="c68d5-166">**类型**</span><span class="sxs-lookup"><span data-stu-id="c68d5-166">**Type**</span></span> | <span data-ttu-id="c68d5-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="c68d5-167">**IdentityRole**</span></span> | <span data-ttu-id="c68d5-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="c68d5-168">**IdentityUserRole**</span></span> | <span data-ttu-id="c68d5-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="c68d5-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="c68d5-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="c68d5-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="c68d5-171">Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-171">Id</span></span> | <span data-ttu-id="c68d5-172">string</span><span class="sxs-lookup"><span data-stu-id="c68d5-172">string</span></span> | <span data-ttu-id="c68d5-173">Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-173">Id</span></span> | <span data-ttu-id="c68d5-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="c68d5-174">RoleId</span></span> | <span data-ttu-id="c68d5-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="c68d5-175">ProviderKey</span></span> | <span data-ttu-id="c68d5-176">Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-176">Id</span></span> |
| <span data-ttu-id="c68d5-177">用户名</span><span class="sxs-lookup"><span data-stu-id="c68d5-177">Username</span></span> | <span data-ttu-id="c68d5-178">string</span><span class="sxs-lookup"><span data-stu-id="c68d5-178">string</span></span> | <span data-ttu-id="c68d5-179">名称</span><span class="sxs-lookup"><span data-stu-id="c68d5-179">Name</span></span> | <span data-ttu-id="c68d5-180">用户 Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-180">UserId</span></span> | <span data-ttu-id="c68d5-181">用户 Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-181">UserId</span></span> | <span data-ttu-id="c68d5-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="c68d5-182">ClaimType</span></span> |
| <span data-ttu-id="c68d5-183">PasswordHash</span><span class="sxs-lookup"><span data-stu-id="c68d5-183">PasswordHash</span></span> | <span data-ttu-id="c68d5-184">string</span><span class="sxs-lookup"><span data-stu-id="c68d5-184">string</span></span> |  |  | <span data-ttu-id="c68d5-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="c68d5-185">LoginProvider</span></span> | <span data-ttu-id="c68d5-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="c68d5-186">ClaimValue</span></span> |
| <span data-ttu-id="c68d5-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="c68d5-187">SecurityStamp</span></span> | <span data-ttu-id="c68d5-188">string</span><span class="sxs-lookup"><span data-stu-id="c68d5-188">string</span></span> |  |  |  | <span data-ttu-id="c68d5-189">用户\_Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-189">User\_Id</span></span> |
| <span data-ttu-id="c68d5-190">电子邮件</span><span class="sxs-lookup"><span data-stu-id="c68d5-190">Email</span></span> | <span data-ttu-id="c68d5-191">string</span><span class="sxs-lookup"><span data-stu-id="c68d5-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="c68d5-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="c68d5-192">EmailConfirmed</span></span> | <span data-ttu-id="c68d5-193">bool</span><span class="sxs-lookup"><span data-stu-id="c68d5-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="c68d5-194">电话号码</span><span class="sxs-lookup"><span data-stu-id="c68d5-194">PhoneNumber</span></span> | <span data-ttu-id="c68d5-195">string</span><span class="sxs-lookup"><span data-stu-id="c68d5-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="c68d5-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="c68d5-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="c68d5-197">bool</span><span class="sxs-lookup"><span data-stu-id="c68d5-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="c68d5-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="c68d5-198">LockoutEnabled</span></span> | <span data-ttu-id="c68d5-199">bool</span><span class="sxs-lookup"><span data-stu-id="c68d5-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="c68d5-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="c68d5-200">LockoutEndDate</span></span> | <span data-ttu-id="c68d5-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="c68d5-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="c68d5-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="c68d5-202">AccessFailedCount</span></span> | <span data-ttu-id="c68d5-203">int</span><span class="sxs-lookup"><span data-stu-id="c68d5-203">int</span></span> |  |  |  |  |

<span data-ttu-id="c68d5-204">我们需要为每个这些模型的表具有与属性相对应的列。</span><span class="sxs-lookup"><span data-stu-id="c68d5-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="c68d5-205">在中定义类和表之间的映射`OnModelCreating`方法`IdentityDBContext`。</span><span class="sxs-lookup"><span data-stu-id="c68d5-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="c68d5-206">这称为配置的 fluent API 方法和可以找到更多信息[此处](https://msdn.microsoft.com/en-us/data/jj591617.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c68d5-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/en-us/data/jj591617.aspx).</span></span> <span data-ttu-id="c68d5-207">类的配置是如下所示</span><span class="sxs-lookup"><span data-stu-id="c68d5-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="c68d5-208">**类**</span><span class="sxs-lookup"><span data-stu-id="c68d5-208">**Class**</span></span> | <span data-ttu-id="c68d5-209">**Table**</span><span class="sxs-lookup"><span data-stu-id="c68d5-209">**Table**</span></span> | <span data-ttu-id="c68d5-210">**主键**</span><span class="sxs-lookup"><span data-stu-id="c68d5-210">**Primary key**</span></span> | <span data-ttu-id="c68d5-211">**外键**</span><span class="sxs-lookup"><span data-stu-id="c68d5-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="c68d5-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="c68d5-212">IdentityUser</span></span> | <span data-ttu-id="c68d5-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="c68d5-213">AspnetUsers</span></span> | <span data-ttu-id="c68d5-214">Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-214">Id</span></span> |  |
| <span data-ttu-id="c68d5-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="c68d5-215">IdentityRole</span></span> | <span data-ttu-id="c68d5-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="c68d5-216">AspnetRoles</span></span> | <span data-ttu-id="c68d5-217">Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-217">Id</span></span> |  |
| <span data-ttu-id="c68d5-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="c68d5-218">IdentityUserRole</span></span> | <span data-ttu-id="c68d5-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="c68d5-219">AspnetUserRole</span></span> | <span data-ttu-id="c68d5-220">UserId + RoleId</span><span class="sxs-lookup"><span data-stu-id="c68d5-220">UserId + RoleId</span></span> | <span data-ttu-id="c68d5-221">用户\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="c68d5-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="c68d5-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="c68d5-222">IdentityUserLogin</span></span> | <span data-ttu-id="c68d5-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="c68d5-223">AspnetUserLogins</span></span> | <span data-ttu-id="c68d5-224">ProviderKey + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="c68d5-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="c68d5-225">用户 Id-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="c68d5-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="c68d5-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="c68d5-226">IdentityUserClaim</span></span> | <span data-ttu-id="c68d5-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="c68d5-227">AspnetUserClaims</span></span> | <span data-ttu-id="c68d5-228">Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-228">Id</span></span> | <span data-ttu-id="c68d5-229">用户\_Id-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="c68d5-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="c68d5-230">使用此信息中，我们可以创建 SQL 语句以创建新表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="c68d5-231">我们可以单独写入每个语句，或生成根据需要使用 EntityFramework PowerShell 命令，然后，我们可以编辑整个脚本。</span><span class="sxs-lookup"><span data-stu-id="c68d5-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="c68d5-232">为此，请在 VS 打开**程序包管理器控制台**从**视图**或**工具**菜单</span><span class="sxs-lookup"><span data-stu-id="c68d5-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="c68d5-233">运行命令"Enable-migrations"以启用 EntityFramework 迁移。</span><span class="sxs-lookup"><span data-stu-id="c68d5-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="c68d5-234">运行命令"add-migration 初始"，这将创建要在 C# 中创建数据库的初始设置代码 / VB.</span><span class="sxs-lookup"><span data-stu-id="c68d5-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="c68d5-235">最后一步是运行"Update-database-脚本"生成 SQL 脚本的命令基于模型类。</span><span class="sxs-lookup"><span data-stu-id="c68d5-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

<span data-ttu-id="c68d5-236">此数据库生成脚本可以用作其中我们将会进行其他更改，以添加新列，将数据复制的开始。</span><span class="sxs-lookup"><span data-stu-id="c68d5-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="c68d5-237">这样做的优点是我们生成`_MigrationHistory`EntityFramework 用于修改数据库架构时模型类针对将来版本的标识发布的更改的表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span> 

<span data-ttu-id="c68d5-238">SQL 成员资格用户信息具有其他以及标识用户模型类即电子邮件中的属性、 密码尝试次数、 上次登录日期、 上次锁定日期等。这是有用的信息，我们希望它转入标识系统。</span><span class="sxs-lookup"><span data-stu-id="c68d5-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="c68d5-239">这可以通过将附加属性添加到用户模型并将其映射回数据库中表的列。</span><span class="sxs-lookup"><span data-stu-id="c68d5-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="c68d5-240">我们可以通过执行此添加类子类`IdentityUser`模型。</span><span class="sxs-lookup"><span data-stu-id="c68d5-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="c68d5-241">我们可以将属性添加到此自定义类和编辑 SQL 脚本，以创建表时添加相应的列。</span><span class="sxs-lookup"><span data-stu-id="c68d5-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="c68d5-242">此类代码进行了进一步的文章中描述。</span><span class="sxs-lookup"><span data-stu-id="c68d5-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="c68d5-243">创建的 SQL 脚本`AspnetUsers`表后将添加新属性</span><span class="sxs-lookup"><span data-stu-id="c68d5-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="c68d5-244">接下来，我们需要将现有信息从 SQL 成员资格数据库复制到新添加的表，标识。</span><span class="sxs-lookup"><span data-stu-id="c68d5-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="c68d5-245">这可以通过 SQL 通过将数据直接从一个表复制到另一个。</span><span class="sxs-lookup"><span data-stu-id="c68d5-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="c68d5-246">若要将数据添加到表中的行，我们使用`INSERT INTO [Table]`构造。</span><span class="sxs-lookup"><span data-stu-id="c68d5-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="c68d5-247">将从另一个表，我们可以使用复制`INSERT INTO`语句连同`SELECT`语句。</span><span class="sxs-lookup"><span data-stu-id="c68d5-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="c68d5-248">若要获取我们需要查询的所有用户信息*aspnet\_用户*和*aspnet\_成员资格*表和复制数据的*AspNetUsers*表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="c68d5-249">我们使用`INSERT INTO`和`SELECT`连同`JOIN`和`LEFT OUTER JOIN`语句。</span><span class="sxs-lookup"><span data-stu-id="c68d5-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="c68d5-250">有关查询和表之间复制数据的详细信息，请参阅[这](https://technet.microsoft.com/en-us/library/ms190750%28v=sql.105%29.aspx)链接。</span><span class="sxs-lookup"><span data-stu-id="c68d5-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/en-us/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="c68d5-251">此外 AspnetUserLogins 和 AspnetUserClaims 表是空开头因为没有在默认情况下映射到此 SQL 成员资格信息。</span><span class="sxs-lookup"><span data-stu-id="c68d5-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="c68d5-252">复制的唯一信息是用户和角色。</span><span class="sxs-lookup"><span data-stu-id="c68d5-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="c68d5-253">对于前面的步骤中创建的项目，为要将信息复制到用户表的 SQL 查询</span><span class="sxs-lookup"><span data-stu-id="c68d5-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="c68d5-254">在上述 SQL 语句中，从每个用户有关的信息*aspnet\_用户*和*aspnet\_成员资格*表复制到的列*AspnetUsers*表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="c68d5-255">我们将密码复制时完成此处的唯一修改。</span><span class="sxs-lookup"><span data-stu-id="c68d5-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="c68d5-256">由于 SQL 成员资格中的密码的加密算法使用 PasswordSalt 和 PasswordFormat，我们将此内容复制太以及经过哈希处理密码，以便可以使用来解密密码的标识。</span><span class="sxs-lookup"><span data-stu-id="c68d5-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="c68d5-257">这中进一步说明文章时挂接自定义密码 hasher。</span><span class="sxs-lookup"><span data-stu-id="c68d5-257">This is explained further in the article when hooking up a custom password hasher.</span></span> 

<span data-ttu-id="c68d5-258">此脚本文件是特定于此示例。</span><span class="sxs-lookup"><span data-stu-id="c68d5-258">This script file is specific to this sample.</span></span> <span data-ttu-id="c68d5-259">对于具有其他表的应用程序，开发人员可以遵循类似的方法在用户模型类上添加其他属性，并将它们映射到 AspnetUsers 表中的列。</span><span class="sxs-lookup"><span data-stu-id="c68d5-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="c68d5-260">若要运行脚本，</span><span class="sxs-lookup"><span data-stu-id="c68d5-260">To run the script,</span></span>

1. <span data-ttu-id="c68d5-261">打开服务器资源管理器。</span><span class="sxs-lookup"><span data-stu-id="c68d5-261">Open Server Explorer.</span></span> <span data-ttu-id="c68d5-262">展开 ApplicationServices 连接，以显示表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="c68d5-263">右键单击表节点并选择新建查询选项</span><span class="sxs-lookup"><span data-stu-id="c68d5-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="c68d5-264">在查询窗口中，复制并粘贴来自 Migrations.sql 文件的整个 SQL 脚本。</span><span class="sxs-lookup"><span data-stu-id="c68d5-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="c68d5-265">通过点击执行箭头按钮运行脚本文件。</span><span class="sxs-lookup"><span data-stu-id="c68d5-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="c68d5-266">刷新服务器资源管理器窗口。</span><span class="sxs-lookup"><span data-stu-id="c68d5-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="c68d5-267">数据库中创建新的五个表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="c68d5-268">下面是 SQL 成员资格表中的信息映射到新的标识系统的方式。</span><span class="sxs-lookup"><span data-stu-id="c68d5-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="c68d5-269">aspnet\_角色-&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="c68d5-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="c68d5-270">asp\_netUsers 和 asp\_netMembership-&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="c68d5-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="c68d5-271">aspnet\_UserInRoles-&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="c68d5-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="c68d5-272">如上面的部分中所述，AspNetUserClaims 和 AspNetUserLogins 表为空。</span><span class="sxs-lookup"><span data-stu-id="c68d5-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="c68d5-273">AspNetUser 表中的鉴别器字段应与匹配的模型类名称，吞吐量被定义为下一步。</span><span class="sxs-lookup"><span data-stu-id="c68d5-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="c68d5-274">PasswordHash 列还采用的形式 ' 加密的密码 | 密码 salt | 密码格式。</span><span class="sxs-lookup"><span data-stu-id="c68d5-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="c68d5-275">这使你可以使用特殊 SQL 成员资格加密逻辑，以便可以重用旧密码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="c68d5-276">是本文后面的部分中所述。</span><span class="sxs-lookup"><span data-stu-id="c68d5-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="c68d5-277">创建模型和成员资格页</span><span class="sxs-lookup"><span data-stu-id="c68d5-277">Creating models and membership pages</span></span>

<span data-ttu-id="c68d5-278">如前所述，标识功能使用实体框架与默认情况下存储帐户信息的数据库通信。</span><span class="sxs-lookup"><span data-stu-id="c68d5-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="c68d5-279">若要使用表中的现有数据，我们需要创建模型类映射回表和挂钩标识系统中。</span><span class="sxs-lookup"><span data-stu-id="c68d5-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="c68d5-280">作为标识协定的一部分，模型类应实现 Identity.Core dll 中定义的接口，也可以扩展 Microsoft.AspNet.Identity.EntityFramework 中提供这些接口的现有实现。</span><span class="sxs-lookup"><span data-stu-id="c68d5-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="c68d5-281">在我们示例中，AspNetRoles、 AspNetUserClaims、 AspNetLogins 和 AspNetUserRole 表具有相似的标识系统的现有实现的列。</span><span class="sxs-lookup"><span data-stu-id="c68d5-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="c68d5-282">因此，我们可以重复使用现有的类将映射到这些表。</span><span class="sxs-lookup"><span data-stu-id="c68d5-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="c68d5-283">AspNetUser 表具有一些额外的列，可用于存储 SQL 成员资格表中的其他信息。</span><span class="sxs-lookup"><span data-stu-id="c68d5-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="c68d5-284">这可以通过创建模型类来扩展 IdentityUser 的现有实现并添加其他属性映射。</span><span class="sxs-lookup"><span data-stu-id="c68d5-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="c68d5-285">可用来创建模型项目中的文件夹并添加类用户。</span><span class="sxs-lookup"><span data-stu-id="c68d5-285">Createa Models folder in the project and add a class User.</span></span> <span data-ttu-id="c68d5-286">类的名称应匹配 AspnetUsers 表的鉴别器列中添加的数据。</span><span class="sxs-lookup"><span data-stu-id="c68d5-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="c68d5-287">用户类应扩展中找到的 IdentityUser 类*Microsoft.AspNet.Identity.EntityFramework* dll。</span><span class="sxs-lookup"><span data-stu-id="c68d5-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="c68d5-288">声明映射回 AspNetUser 列中类的属性。</span><span class="sxs-lookup"><span data-stu-id="c68d5-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="c68d5-289">属性 ID、 用户名、 PasswordHash 和 SecurityStamp IdentityUser 中定义，并且省略了。</span><span class="sxs-lookup"><span data-stu-id="c68d5-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="c68d5-290">下面是具有所有属性的用户类的代码</span><span class="sxs-lookup"><span data-stu-id="c68d5-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="c68d5-291">实体框架 DbContext 类需要持久保存回表的模型中的数据并从表来填充模型中检索数据。</span><span class="sxs-lookup"><span data-stu-id="c68d5-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="c68d5-292">*Microsoft.AspNet.Identity.EntityFramework* dll 定义与这些标识表以检索并存储信息交互的 IdentityDbContext 类。</span><span class="sxs-lookup"><span data-stu-id="c68d5-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="c68d5-293">IdentityDbContext&lt;热熔器&gt;采用热熔器类可以是任何扩展 IdentityUser 类的类。</span><span class="sxs-lookup"><span data-stu-id="c68d5-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="c68d5-294">创建一个新类扩展模型文件夹下，在步骤 1 中创建的 'User' 类传入 IdentityDbContext 的 ApplicationDBContext</span><span class="sxs-lookup"><span data-stu-id="c68d5-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="c68d5-295">完成新的标识系统中的用户管理使用 UserManager&lt;热熔器&gt;中定义的类*Microsoft.AspNet.Identity.EntityFramework* dll。</span><span class="sxs-lookup"><span data-stu-id="c68d5-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="c68d5-296">我们需要创建自定义扩展的类的 UserManager，在步骤 1 中创建的 'User' 类传递。</span><span class="sxs-lookup"><span data-stu-id="c68d5-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="c68d5-297">在模型文件夹中创建一个新的类扩展 UserManager UserManager&lt;用户&gt;</span><span class="sxs-lookup"><span data-stu-id="c68d5-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="c68d5-298">应用程序的用户的密码进行加密和存储在数据库中。</span><span class="sxs-lookup"><span data-stu-id="c68d5-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="c68d5-299">使用 SQL 成员资格中的加密算法是不同的是新的标识系统中。</span><span class="sxs-lookup"><span data-stu-id="c68d5-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="c68d5-300">若要重用旧密码我们需要在为新的用户在标识中使用的加密算法时使用 SQL 成员身份算法的旧用户登录时有选择地解密密码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="c68d5-301">UserManager 类具有一个属性存储实现 IPasswordHasher 接口的类的实例的 PasswordHasher。</span><span class="sxs-lookup"><span data-stu-id="c68d5-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="c68d5-302">使用此密码进行加密/解密用户身份验证事务处理期间。</span><span class="sxs-lookup"><span data-stu-id="c68d5-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="c68d5-303">在步骤 3 中定义的 UserManager 类，创建一个新类 SQLPasswordHasher 和复制下面的代码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="c68d5-304">通过导入 System.Text 和 System.Security.Cryptography 命名空间中解决编译错误。</span><span class="sxs-lookup"><span data-stu-id="c68d5-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="c68d5-305">EncodePassword 方法对根据默认 SQL 成员资格加密实现的密码进行加密。</span><span class="sxs-lookup"><span data-stu-id="c68d5-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="c68d5-306">这将取自 System.Web dll。</span><span class="sxs-lookup"><span data-stu-id="c68d5-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="c68d5-307">如果旧版应用程序使用的自定义实现则它应反映此处。</span><span class="sxs-lookup"><span data-stu-id="c68d5-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="c68d5-308">我们需要定义两个其他方法*HashPassword*和*VerifyHashedPassword*使用*EncodePassword*方法可以提供的密码执行哈希或验证了纯文本与一个现有数据库中的密码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="c68d5-309">SQL 成员资格系统使用 PasswordHash、 PasswordSalt 和 PasswordFormat 进行哈希在注册或更改其密码时，由用户输入的密码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="c68d5-310">在迁移期间所有三个字段存储隔开 AspNetUser 表中的 PasswordHash 列在 | 字符。</span><span class="sxs-lookup"><span data-stu-id="c68d5-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="c68d5-311">当用户登录和密码包含的这些字段时，我们可以使用 SQL 成员资格加密来检查密码，则为否则我们使用的标识系统的默认加密以验证密码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="c68d5-312">这种方式旧用户不需要迁移应用程序后更改其密码。</span><span class="sxs-lookup"><span data-stu-id="c68d5-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="c68d5-313">声明 UserManager 类的构造函数，并将此作为 SQLPasswordHasher 传递给构造函数中的属性。</span><span class="sxs-lookup"><span data-stu-id="c68d5-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="c68d5-314">创建新的帐户管理页</span><span class="sxs-lookup"><span data-stu-id="c68d5-314">Create new account management pages</span></span>

<span data-ttu-id="c68d5-315">迁移的下一步是添加将允许用户注册和登录的帐户管理页。</span><span class="sxs-lookup"><span data-stu-id="c68d5-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="c68d5-316">从 SQL 成员资格的旧帐户页使用的新的标识系统不支持的控件。</span><span class="sxs-lookup"><span data-stu-id="c68d5-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="c68d5-317">若要添加新用户管理页，请按照教程在以下链接[https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md)从步骤启动为注册到你的应用程序的用户添加 Web 窗体由于我们已经创建该项目并添加 NuGet 包。</span><span class="sxs-lookup"><span data-stu-id="c68d5-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="c68d5-318">我们需要进行一些更改以处理我们在这里有项目的示例。</span><span class="sxs-lookup"><span data-stu-id="c68d5-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="c68d5-319">Register.aspx.cs 和 Login.aspx.cs 代码隐藏类可以使用该`UserManager`从标识包来创建的用户。</span><span class="sxs-lookup"><span data-stu-id="c68d5-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="c68d5-320">对于此示例使用添加 Models 文件夹中，按照前面所述的步骤 UserManager。</span><span class="sxs-lookup"><span data-stu-id="c68d5-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="c68d5-321">使用创建而不是 IdentityUser Register.aspx.cs 和 Login.aspx.cs 代码隐藏类中的用户类。</span><span class="sxs-lookup"><span data-stu-id="c68d5-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="c68d5-322">这挂钩我们自定义用户类中的标识系统。</span><span class="sxs-lookup"><span data-stu-id="c68d5-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="c68d5-323">要创建数据库的部件，可以跳过。</span><span class="sxs-lookup"><span data-stu-id="c68d5-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="c68d5-324">开发人员需要设置新用户 ApplicationId，以匹配当前的应用程序 id。</span><span class="sxs-lookup"><span data-stu-id="c68d5-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="c68d5-325">这可以通过查询此应用程序 ApplicationId 之前 Register.aspx.cs 类中创建用户对象并将其设置在创建用户之前。</span><span class="sxs-lookup"><span data-stu-id="c68d5-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span> 

    <span data-ttu-id="c68d5-326">示例:</span><span class="sxs-lookup"><span data-stu-id="c68d5-326">Example:</span></span>

    <span data-ttu-id="c68d5-327">定义一个方法中 Register.aspx.cs 页后，可以查询 aspnet\_应用程序表，并根据应用程序名称获取应用程序 Id</span><span class="sxs-lookup"><span data-stu-id="c68d5-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="c68d5-328">现在获取或设置此用户对象上</span><span class="sxs-lookup"><span data-stu-id="c68d5-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="c68d5-329">使用旧的用户名和密码登录现有用户。</span><span class="sxs-lookup"><span data-stu-id="c68d5-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="c68d5-330">使用注册页来创建新用户。</span><span class="sxs-lookup"><span data-stu-id="c68d5-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="c68d5-331">此外验证的用户是在角色中，按预期方式。</span><span class="sxs-lookup"><span data-stu-id="c68d5-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="c68d5-332">迁移到的标识系统，从而帮助用户将开放式身份验证 (OAuth) 添加到应用程序。</span><span class="sxs-lookup"><span data-stu-id="c68d5-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="c68d5-333">此示例，请参阅[此处](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/)具有启用的 OAuth。</span><span class="sxs-lookup"><span data-stu-id="c68d5-333">Please refer to the sample [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="c68d5-334">后续步骤</span><span class="sxs-lookup"><span data-stu-id="c68d5-334">Next Steps</span></span>

<span data-ttu-id="c68d5-335">在本教程中，我们介绍了如何移植到 ASP.NET 标识从 SQL 成员资格用户，但我们未端口配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="c68d5-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="c68d5-336">在下一教程中，我们将了解到移植到新的标识系统的配置文件数据从 SQL 成员资格。</span><span class="sxs-lookup"><span data-stu-id="c68d5-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="c68d5-337">你可以将在本文底部的反馈。</span><span class="sxs-lookup"><span data-stu-id="c68d5-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="c68d5-338">*感谢 Tom Dykstra 和 Rick Anderson 对本文的审阅。*</span><span class="sxs-lookup"><span data-stu-id="c68d5-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
