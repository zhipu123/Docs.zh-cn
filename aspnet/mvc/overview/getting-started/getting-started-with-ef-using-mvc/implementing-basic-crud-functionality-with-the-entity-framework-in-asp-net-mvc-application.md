---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
title: "在 ASP.NET MVC 应用程序中实现与实体框架的基本 CRUD 功能 |Microsoft 文档"
author: tdykstra
description: "Contoso 大学示例 web 应用程序演示如何创建使用 Entity Framework 6 Code First 和 Visual Studio 的 ASP.NET MVC 5 应用程序..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/09/2015
ms.topic: article
ms.assetid: a2f70ba4-83d1-4002-9255-24732726c4f2
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: c63b8f591023b68720c523d1c9184a527a34e9cc
ms.sourcegitcommit: e4fb6b13be56a0fb2f2778623740a047d6489227
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/16/2017
---
<a name="implementing-basic-crud-functionality-with-the-entity-framework-in-aspnet-mvc-application"></a><span data-ttu-id="cbd3d-103">在 ASP.NET MVC 应用程序中实现与实体框架的基本 CRUD 功能</span><span class="sxs-lookup"><span data-stu-id="cbd3d-103">Implementing Basic CRUD Functionality with the Entity Framework in ASP.NET MVC Application</span></span>
====================
<span data-ttu-id="cbd3d-104">通过[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

<span data-ttu-id="cbd3d-105">[下载已完成的项目](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8)或[下载 PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-105">[Download Completed Project](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8) or [Download PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)</span></span>

> <span data-ttu-id="cbd3d-106">Contoso 大学示例 web 应用程序演示如何创建使用 Entity Framework 6 Code First 和 Visual Studio 2013 的 ASP.NET MVC 5 应用程序。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 5 applications using the Entity Framework 6 Code First and Visual Studio 2013.</span></span> <span data-ttu-id="cbd3d-107">有关教程系列的信息，请参阅[序列中的第一个教程](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>


<span data-ttu-id="cbd3d-108">在以前的教程，你创建的 MVC 应用程序存储和显示数据使用实体框架和 SQL Server LocalDB。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-108">In the previous tutorial you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="cbd3d-109">在本教程中，你将查看和自定义 CRUD （创建、 读取、 更新、 删除） 的 MVC 基架自动为你创建在控制器和视图中的代码。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-109">In this tutorial you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE]
> <span data-ttu-id="cbd3d-110">它是常见的做法，以便创建你的控制器和数据访问层之间的抽象层实现存储库模式。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-110">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="cbd3d-111">若要使这些教程简单和关注教学如何使用实体框架本身，它们不使用存储库。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-111">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="cbd3d-112">有关如何实现存储库的信息，请参阅[ASP.NET 数据访问内容映射](../../../../whitepapers/aspnet-data-access-content-map.md)。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-112">For information about how to implement repositories, see the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>


<span data-ttu-id="cbd3d-113">在本教程中，你将创建以下网页：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-113">In this tutorial, you'll create the following web pages:</span></span>

![Student_Details_page](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image1.png)

![Student_Edit_page](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image2.png)

![Student_delete_page](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image3.png)

## <a name="create-a-details-page"></a><span data-ttu-id="cbd3d-117">创建详细信息页</span><span class="sxs-lookup"><span data-stu-id="cbd3d-117">Create a Details Page</span></span>

<span data-ttu-id="cbd3d-118">学生的基架的代码`Index`页中省略`Enrollments`属性，因为该属性包含集合。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-118">The scaffolded code for the Students `Index` page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="cbd3d-119">在`Details`将集合的内容显示在 HTML 表的页。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-119">In the `Details` page you'll display the contents of the collection in an HTML table.</span></span>

 <span data-ttu-id="cbd3d-120">在*Controllers\StudentController.cs*的操作方法`Details`查看使用[查找](https://msdn.microsoft.com/en-us/library/gg696418(v=VS.103).aspx)方法来检索单个`Student`实体。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-120">In *Controllers\StudentController.cs*, the action method for the `Details` view uses the [Find](https://msdn.microsoft.com/en-us/library/gg696418(v=VS.103).aspx) method to retrieve a single `Student` entity.</span></span> 

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="cbd3d-121">密钥的值传递给该方法为`id`参数和来自*将数据路由*中**详细信息**索引网页上的超链接。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-121">The key value is passed to the method as the `id` parameter and comes from *route data* in the **Details** hyperlink on the Index page.</span></span>

### <a name="tip-route-data"></a><span data-ttu-id="cbd3d-122">提示：**路由数据**</span><span class="sxs-lookup"><span data-stu-id="cbd3d-122">Tip: **Route data**</span></span>

<span data-ttu-id="cbd3d-123">路由数据是在路由表中指定的 URL 段中找到模型联编程序的数据。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-123">Route data is data that the model binder found in a URL segment specified in the routing table.</span></span> <span data-ttu-id="cbd3d-124">例如，默认路由指定`controller`， `action`，和`id`段：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-124">For example, the default route specifies `controller`, `action`, and `id` segments:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample2.cs?highlight=3)]

<span data-ttu-id="cbd3d-125">在下面的 URL，将默认路由映射`Instructor`作为`controller`，`Index`作为`action`并将它作为 1 `id`; 这些是路由数据值。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-125">In the following URL, the default route maps `Instructor` as the `controller`, `Index` as the `action` and 1 as the `id`; these are route data values.</span></span>

`http://localhost:1230/Instructor/Index/1?courseID=2021`

<span data-ttu-id="cbd3d-126">"？ courseID = 2021年"是一个查询字符串值。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-126">"?courseID=2021" is a query string value.</span></span> <span data-ttu-id="cbd3d-127">模型联编程序还将起作用，如果你通过`id`作为查询字符串值：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-127">The model binder will also work if you pass the `id` as a query string value:</span></span>

`http://localhost:1230/Instructor/Index?id=1&CourseID=2021`

<span data-ttu-id="cbd3d-128">通过创建 Url `ActionLink` Razor 视图中的语句。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-128">The URLs are created by `ActionLink` statements in the Razor view.</span></span> <span data-ttu-id="cbd3d-129">在下面的代码中，`id`参数和默认路由匹配，因此`id`将添加到路由数据。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-129">In the following code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample3.cshtml)]

<span data-ttu-id="cbd3d-130">在下面的代码中，`courseID`不匹配默认路由中的参数，因此，它将添加作为查询字符串。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-130">In the following code, `courseID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

[!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample4.cshtml)]


1. <span data-ttu-id="cbd3d-131">打开*Views\Student\Details.cshtml*。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-131">Open *Views\Student\Details.cshtml*.</span></span> <span data-ttu-id="cbd3d-132">使用显示每个字段`DisplayFor`帮助器，如下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-132">Each field is displayed using a `DisplayFor` helper, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample5.cshtml)]
2. <span data-ttu-id="cbd3d-133">后`EnrollmentDate`字段和立即在关闭前`</dl>`标记中，添加突出显示的代码，以显示列表的注册，如下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-133">After the `EnrollmentDate` field and immediately before the closing `</dl>` tag, add the highlighted code to display a list of enrollments, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample6.cshtml?highlight=8-29)]

    <span data-ttu-id="cbd3d-134">如果后粘贴代码，代码缩进有误，，按 CTRL-K-D 更正它。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-134">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

    <span data-ttu-id="cbd3d-135">此代码循环访问中的实体`Enrollments`导航属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-135">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="cbd3d-136">每个`Enrollment`实体属性中，它显示课程标题和评分。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-136">For each `Enrollment` entity in the property, it displays the course title and the grade.</span></span> <span data-ttu-id="cbd3d-137">正在从检索课程标题`Course`中存储的实体`Course`导航属性`Enrollments`实体。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-137">The course title is retrieved from the `Course` entity that's stored in the `Course` navigation property of the `Enrollments` entity.</span></span> <span data-ttu-id="cbd3d-138">所有这些数据是从数据库中检索自动需要时。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-138">All of this data is retrieved from the database automatically when it's needed.</span></span> <span data-ttu-id="cbd3d-139">（在换而言之，你正在使用延迟加载此处。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-139">(In other words, you are using lazy loading here.</span></span> <span data-ttu-id="cbd3d-140">未指定*预先加载*为`Courses`导航属性，因此注册未检索到在同一查询中获取学生。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-140">You did not specify *eager loading* for the `Courses` navigation property, so the enrollments were not retrieved in the same query that got the students.</span></span> <span data-ttu-id="cbd3d-141">相反，第一次尝试访问`Enrollments`导航属性，一个新的查询将发送到数据库以检索数据。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-141">Instead, the first time you try to access the `Enrollments` navigation property, a new query is sent to the database to retrieve the data.</span></span> <span data-ttu-id="cbd3d-142">你可以阅读更多有关延迟加载和中的预先加载[读取相关数据](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md)更高版本中这一系列教程。)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-142">You can read more about lazy loading and eager loading in the [Reading Related Data](reading-related-data-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial later in this series.)</span></span>
3. <span data-ttu-id="cbd3d-143">通过选择运行页面**学生**选项卡上，单击**详细信息**Alexander Carson 的链接。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-143">Run the page by selecting the **Students** tab and clicking a **Details** link for Alexander Carson.</span></span> <span data-ttu-id="cbd3d-144">（如果 Details.cshtml 文件处于打开状态时按 CTRL + F5，则将会返回 HTTP 400 错误因为 Visual Studio 尝试运行的详细信息页，但它不从一个链接，以指定要显示学生已达到。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-144">(If you press CTRL+F5 while the Details.cshtml file is open, you'll get an HTTP 400 error because Visual Studio tries to run the Details page but it wasn't reached from a link that specifies the student to display.</span></span> <span data-ttu-id="cbd3d-145">In that case，只需从 URL 中删除"学生/详细信息"和重试，或关闭浏览器、 右键单击项目，然后单击**视图**，然后单击**用浏览器查看**。)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-145">In that case, just remove "Student/Details" from the URL and try again, or close the browser, right-click the project, and click **View**, and then click **View in Browser**.)</span></span>

    <span data-ttu-id="cbd3d-146">为所选学生查看课程和年级的列表：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-146">You see the list of courses and grades for the selected student:</span></span>

    ![Student_Details_page](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image4.png)

## <a name="update-the-create-page"></a><span data-ttu-id="cbd3d-148">更新创建页</span><span class="sxs-lookup"><span data-stu-id="cbd3d-148">Update the Create Page</span></span>

1. <span data-ttu-id="cbd3d-149">在*Controllers\StudentController.cs*，替换`HttpPost``Create`操作方法替换为以下代码以添加`try-catch`阻止和删除`ID`从[绑定属性](https://msdn.microsoft.com/en-us/library/system.web.mvc.bindattribute(v=vs.108).aspx)为基架的方法：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-149">In *Controllers\StudentController.cs*, replace the `HttpPost``Create` action method with the following code to add a `try-catch` block and remove `ID` from the [Bind attribute](https://msdn.microsoft.com/en-us/library/system.web.mvc.bindattribute(v=vs.108).aspx) for the scaffolded method:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample7.cs?highlight=3,5-6,13-18)]

    <span data-ttu-id="cbd3d-150">此代码将添加`Student`实体创建的 ASP.NET MVC 模型联编程序到`Students`实体设置，然后将所做的更改保存到数据库。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-150">This code adds the `Student` entity created by the ASP.NET MVC model binder to the `Students` entity set and then saves the changes to the database.</span></span> <span data-ttu-id="cbd3d-151">(*模型联编程序*指使它可以更轻松地处理提交的窗体的数据; 模型联编程序将发布窗体到 CLR 类型值，并将其传递给参数中的操作方法的 ASP.NET MVC 功能。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-151">(*Model binder* refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="cbd3d-152">模型联编程序的实例化 in this case，`Student`为你使用属性的实体值从`Form`集合。)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-152">In this case, the model binder instantiates a `Student` entity for you using property values from the `Form` collection.)</span></span>

    <span data-ttu-id="cbd3d-153">你删除`ID`从绑定特性，因为`ID`是 SQL Server 将插入行时自动设置的主键值。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-153">You removed `ID` from the Bind attribute because `ID` is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="cbd3d-154">来自用户的输入不会设置`ID`值。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-154">Input from the user does not set the `ID` value.</span></span>

    <a id="overpost"></a>

    ### <a name="security-warning---the-validateantiforgerytoken-attribute-helps-prevent-cross-site-request-forgerysecurityxsrfcsrf-prevention-in-aspnet-mvc-and-web-pagesmd-attacks-it-requires-a-corresponding-htmlantiforgerytoken-statement-in-the-view-which-youll-see-later"></a><span data-ttu-id="cbd3d-155">安全警告-`ValidateAntiForgeryToken`属性有助于防止[跨站点请求伪造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻击。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-155">Security warning - The `ValidateAntiForgeryToken` attribute helps prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span> <span data-ttu-id="cbd3d-156">它需要相应`Html.AntiForgeryToken()`语句在视图中，您可以看到更高版本。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-156">It requires a corresponding `Html.AntiForgeryToken()` statement in the view, which you'll see later.</span></span>

    <span data-ttu-id="cbd3d-157">`Bind`属性是一种方法，以防止*过度发布*中创建的方案。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-157">The `Bind` attribute is one way to protect against *over-posting* in create scenarios.</span></span> <span data-ttu-id="cbd3d-158">例如，假设`Student`实体包含`Secret`你不希望此网页可设置的属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-158">For example, suppose the `Student` entity includes a `Secret` property that you don't want this web page to set.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample8.cs?highlight=7)]

    <span data-ttu-id="cbd3d-159">即使你没有`Secret`在网页上，黑客字段无法使用一种工具如[fiddler](http://fiddler2.com/home)，或编写一些 JavaScript，发布`Secret`形成的值。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-159">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as [fiddler](http://fiddler2.com/home), or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="cbd3d-160">而无需[绑定](https://msdn.microsoft.com/en-us/library/system.web.mvc.bindattribute(v=vs.108).aspx)限制模型联编程序使用在创建时的字段的特性`Student`实例*，*模型联编程序会选取，`Secret`形成的值以及使用它创建`Student`实体实例。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-160">Without the [Bind](https://msdn.microsoft.com/en-us/library/system.web.mvc.bindattribute(v=vs.108).aspx) attribute limiting the fields that the model binder uses when it creates a `Student` instance*,* the model binder would pick up that `Secret` form value and use it to create the `Student` entity instance.</span></span> <span data-ttu-id="cbd3d-161">然后任何值为指定黑客`Secret`窗体字段将在你的数据库中更新。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-161">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="cbd3d-162">下图显示 fiddler 工具添加`Secret`（具有值"OverPost"） 到已发布的窗体值的字段。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-162">The following image shows the fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

    ![](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image5.png)  

    <span data-ttu-id="cbd3d-163">随后将可"OverPost"成功添加到的值`Secret`属性插入行，尽管你永远不会预期网页能够设置该属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-163">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

    <span data-ttu-id="cbd3d-164">它是使用的安全最佳实践`Include`参数`Bind`属性设为*白名单*字段。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-164">It's a security best practice to use the `Include` parameter with the `Bind` attribute to *whitelist* fields.</span></span> <span data-ttu-id="cbd3d-165">还有可能要使用`Exclude`参数*黑名单*你想要排除的字段。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-165">It's also possible to use the `Exclude` parameter to *blacklist* fields you want to exclude.</span></span> <span data-ttu-id="cbd3d-166">原因`Include`更安全是，当将新属性添加到实体，新的字段不会自动受`Exclude`列表。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-166">The reason `Include` is more secure is that when you add a new property to the entity, the new field is not automatically protected by an `Exclude` list.</span></span>

    <span data-ttu-id="cbd3d-167">你可以阻止在编辑方案中的 overposting 是通过先从数据库读取实体，然后再调用`TryUpdateModel`，并传递显式允许的属性列表中。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-167">You can prevent overposting in edit scenarios is by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="cbd3d-168">这是这些教程中使用的方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-168">That is the method used in these tutorials.</span></span>

    <span data-ttu-id="cbd3d-169">防止首选许多开发人员的 overposting 一种备用方法是使用视图模型，而不是实体类与模型绑定。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-169">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="cbd3d-170">包括你想要在视图模型中更新的属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-170">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="cbd3d-171">完成 MVC 模型联编程序后，将视图模型属性复制到实体实例，根据需要使用一种工具如[AutoMapper](http://automapper.org/)。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-171">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as [AutoMapper](http://automapper.org/).</span></span> <span data-ttu-id="cbd3d-172">使用数据库。要将其状态设置为未更改，并将 Property("PropertyName") 的实体实例的项。为 true 的每个实体属性的视图模型中包含的 IsModified。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-172">Use db.Entry on the entity instance to set its state to Unchanged, and then set Property("PropertyName").IsModified to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="cbd3d-173">此方法适用于同时编辑和创建方案。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-173">This method works in both edit and create scenarios.</span></span>

    <span data-ttu-id="cbd3d-174">除`Bind`属性，`try-catch`块是唯一的基架的代码所做的更改。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-174">Other than the `Bind` attribute, the `try-catch` block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="cbd3d-175">如果异常派生自[DataException](https://msdn.microsoft.com/en-us/library/system.data.dataexception.aspx)是捕捉到正在保存所做的更改时，将显示一般错误消息。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-175">If an exception that derives from [DataException](https://msdn.microsoft.com/en-us/library/system.data.dataexception.aspx) is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="cbd3d-176">[DataException](https://msdn.microsoft.com/en-us/library/system.data.dataexception.aspx)以便建议用户以重试，由外部的应用程序，而不是编程错误，有时会导致异常。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-176">[DataException](https://msdn.microsoft.com/en-us/library/system.data.dataexception.aspx) exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="cbd3d-177">尽管在此示例中未实现，但生产质量应用程序会将异常记录。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-177">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="cbd3d-178">有关详细信息，请参阅**要深入探索日志**主题中[监视和遥测 （构建真实世界云应用程序与 Azure）](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log)。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-178">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](../../../../aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry.md#log).</span></span>

    <span data-ttu-id="cbd3d-179">中的代码*Views\Student\Create.cshtml*类似于你在中看到*Details.cshtml*，只不过`EditorFor`和`ValidationMessageFor`帮助器用于每个字段而不是`DisplayFor`.</span><span class="sxs-lookup"><span data-stu-id="cbd3d-179">The code in *Views\Student\Create.cshtml* is similar to what you saw in *Details.cshtml*, except that `EditorFor` and `ValidationMessageFor` helpers are used for each field instead of `DisplayFor`.</span></span> <span data-ttu-id="cbd3d-180">下面是相关的代码：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-180">Here is the relevant code:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample9.cshtml)]

    <span data-ttu-id="cbd3d-181">*Create.chstml*还包括`@Html.AntiForgeryToken()`，其工作方式与`ValidateAntiForgeryToken`属性中的控制器，以帮助防止[跨站点请求伪造](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md)攻击。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-181">*Create.chstml* also includes `@Html.AntiForgeryToken()`, which works with the `ValidateAntiForgeryToken` attribute in the controller to help prevent [cross-site request forgery](../../security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages.md) attacks.</span></span>

    <span data-ttu-id="cbd3d-182">在需要进行任何更改*Create.cshtml*。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-182">No changes are required in *Create.cshtml*.</span></span>
2. <span data-ttu-id="cbd3d-183">通过选择运行页面**学生**选项卡上，单击**新建**。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-183">Run the page by selecting the **Students** tab and clicking **Create New**.</span></span>
3. <span data-ttu-id="cbd3d-184">输入名称和一个无效的日期，然后单击**创建**可查看错误消息。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-184">Enter names and an invalid date and click **Create** to see the error message.</span></span>

    ![Students_Create_page_error_message](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image6.png)

    <span data-ttu-id="cbd3d-186">这是默认情况下; 获取的服务器端验证在更高版本的教程中，你将看到如何添加还将生成代码以便进行客户端验证的属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-186">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="cbd3d-187">以下突出显示的代码演示模型验证检查在**创建**方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-187">The following highlighted code shows the model validation check in the **Create** method.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample10.cs?highlight=1)]
4. <span data-ttu-id="cbd3d-188">将日期更改为有效的值并单击**创建**若要查看显示在新学生**索引**页。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-188">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

    ![Students_Index_page_with_new_student](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image7.png)

## <a name="update-the-edit-httppost-method"></a><span data-ttu-id="cbd3d-190">更新编辑 HttpPost 方法</span><span class="sxs-lookup"><span data-stu-id="cbd3d-190">Update the Edit HttpPost Method</span></span>

<span data-ttu-id="cbd3d-191">在*Controllers\StudentController.cs*、 `HttpGet` `Edit`方法 (而不是`HttpPost`属性) 使用`Find`方法来检索所选`Student`作为你看到的实体，在`Details`方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-191">In *Controllers\StudentController.cs*, the `HttpGet` `Edit` method (the one without the `HttpPost` attribute) uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="cbd3d-192">你不需要更改此方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-192">You don't need to change this method.</span></span>

<span data-ttu-id="cbd3d-193">但是，替换`HttpPost``Edit`操作方法替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-193">However, replace the `HttpPost` `Edit` action method with the following code:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample11.cs)]

<span data-ttu-id="cbd3d-194">这些更改实现安全的最佳做法，以防止[过多发布](#overpost)，生成基架`Bind`属性，并添加到的实体集使用已修改标志模型联编程序所创建的实体。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-194">These changes implement a security best practice to prevent [overposting](#overpost), The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a Modified flag.</span></span> <span data-ttu-id="cbd3d-195">因为不再建议代码`Bind`属性将清除任何预先存在的数据中未列出的字段中`Include`参数。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-195">That code is no longer recommended because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span> <span data-ttu-id="cbd3d-196">将来，MVC 控制器 scaffolder 将进行更新，以便它不会生成`Bind`编辑方法的属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-196">In the future, the MVC controller scaffolder will be updated so that it doesn't generate `Bind` attributes for Edit methods.</span></span>

<span data-ttu-id="cbd3d-197">新的代码读取的现有实体和调用[TryUpdateModel](https://msdn.microsoft.com/en-us/library/system.web.mvc.controller.tryupdatemodel(v=vs.118).aspx)更新中的已发布的窗体数据中的用户输入的字段。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-197">The new code reads the existing entity and calls [TryUpdateModel](https://msdn.microsoft.com/en-us/library/system.web.mvc.controller.tryupdatemodel(v=vs.118).aspx) to update fields from user input in the posted form data.</span></span> <span data-ttu-id="cbd3d-198">实体框架自动更改跟踪设置[已修改](https://msdn.microsoft.com/en-us/library/system.data.entitystate.aspx)实体上的标志。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-198">The Entity Framework's automatic change tracking sets the [Modified](https://msdn.microsoft.com/en-us/library/system.data.entitystate.aspx) flag on the entity.</span></span> <span data-ttu-id="cbd3d-199">当[SaveChanges](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)调用方法时，`Modified`标志会导致实体框架创建 SQL 语句，以更新数据库行。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-199">When the [SaveChanges](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method is called, the `Modified` flag causes the Entity Framework to create SQL statements to update the database row.</span></span> <span data-ttu-id="cbd3d-200">[并发冲突](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)将被忽略，并更新数据库行中的所有列，包括那些用户未更改。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-200">[Concurrency conflicts](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) are ignored, and all columns of the database row are updated, including those that the user didn't change.</span></span> <span data-ttu-id="cbd3d-201">(后面的教程演示如何处理并发冲突，如果你只想要更新数据库中的各个字段，你可以设置为未更改的实体，设置单个字段以修改时间。)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-201">(A later tutorial shows how to handle concurrency conflicts, and if you only want individual fields to be updated in the database, you can set the entity to Unchanged and set individual fields to Modified.)</span></span>

<span data-ttu-id="cbd3d-202">作为最佳做法是以防止 overposting，你想要通过编辑页可更新的字段被列入白名单中的`TryUpdateModel`参数。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-202">As a best practice to prevent overposting, the fields that you want to be updateable by the Edit page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="cbd3d-203">当前没有额外字段，你要保护的但列出你想要绑定的模型联编程序的字段可确保，如果在将来将字段添加到数据模型，它们是否自动受到保护之前你显式将其添加此处。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-203">Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="cbd3d-204">由于这些更改，HttpPost 编辑方法的方法签名等同于 HttpGet 编辑方法;因此，你已重命名方法 EditPost。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-204">As a result of these changes, the method signature of the HttpPost Edit method is the same as the HttpGet edit method; therefore you've renamed the method EditPost.</span></span>

> [!TIP] 
> 
> <span data-ttu-id="cbd3d-205">**实体状态的附加和 SaveChanges 方法**</span><span class="sxs-lookup"><span data-stu-id="cbd3d-205">**Entity States and the Attach and SaveChanges Methods**</span></span>
> 
> <span data-ttu-id="cbd3d-206">是否在内存中的实体是在数据库中，其对应行与同步，此信息确定在调用时，会发生什么情况，将跟踪的数据库上下文`SaveChanges`方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-206">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="cbd3d-207">例如，当传递到新实体[添加](https://msdn.microsoft.com/en-us/library/system.data.entity.dbset.add(v=vs.103).aspx)方法，该实体的状态设置为方法`Added`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-207">For example, when you pass a new entity to the [Add](https://msdn.microsoft.com/en-us/library/system.data.entity.dbset.add(v=vs.103).aspx) method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="cbd3d-208">然后调用[SaveChanges](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法，数据库上下文发出 SQL`INSERT`命令。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-208">Then when you call the [SaveChanges](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method, the database context issues a SQL `INSERT` command.</span></span>
> 
> <span data-ttu-id="cbd3d-209">实体可能之一[以下状态](https://msdn.microsoft.com/en-us/library/system.data.entitystate.aspx):</span><span class="sxs-lookup"><span data-stu-id="cbd3d-209">An entity may be in one of the[following states](https://msdn.microsoft.com/en-us/library/system.data.entitystate.aspx):</span></span>
> 
> - <span data-ttu-id="cbd3d-210">`Added`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-210">`Added`.</span></span> <span data-ttu-id="cbd3d-211">实体在数据库中尚不存在。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-211">The entity does not yet exist in the database.</span></span> <span data-ttu-id="cbd3d-212">`SaveChanges`方法必须发出`INSERT`语句。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-212">The `SaveChanges` method must issue an `INSERT` statement.</span></span>
> - <span data-ttu-id="cbd3d-213">`Unchanged`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-213">`Unchanged`.</span></span> <span data-ttu-id="cbd3d-214">无需使用通过此实体完成`SaveChanges`方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-214">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="cbd3d-215">当从数据库读取实体时，该实体开始时具有此状态。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-215">When you read an entity from the database, the entity starts out with this status.</span></span>
> - <span data-ttu-id="cbd3d-216">`Modified`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-216">`Modified`.</span></span> <span data-ttu-id="cbd3d-217">某些或所有实体的属性值已都更改。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-217">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="cbd3d-218">`SaveChanges`方法必须发出`UPDATE`语句。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-218">The `SaveChanges` method must issue an `UPDATE` statement.</span></span>
> - <span data-ttu-id="cbd3d-219">`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-219">`Deleted`.</span></span> <span data-ttu-id="cbd3d-220">实体已标记为删除。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-220">The entity has been marked for deletion.</span></span> <span data-ttu-id="cbd3d-221">`SaveChanges`方法必须发出`DELETE`语句。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-221">The `SaveChanges` method must issue a `DELETE` statement.</span></span>
> - <span data-ttu-id="cbd3d-222">`Detached`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-222">`Detached`.</span></span> <span data-ttu-id="cbd3d-223">实体不跟踪的数据库上下文。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-223">The entity isn't being tracked by the database context.</span></span>
> 
> <span data-ttu-id="cbd3d-224">在桌面应用中，通常会自动设置状态更改。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-224">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="cbd3d-225">在桌面类型的应用程序，你可以阅读实体并对它的一些属性值进行更改。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-225">In a desktop type of application, you read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="cbd3d-226">这将导致其实体状态自动更改为`Modified`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-226">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="cbd3d-227">然后调用`SaveChanges`，实体框架生成 SQL`UPDATE`更新仅你更改的实际属性的语句。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-227">Then when you call `SaveChanges`, the Entity Framework generates a SQL `UPDATE` statement that updates only the actual properties that you changed.</span></span>
> 
> <span data-ttu-id="cbd3d-228">Web 应用断开连接的特性不允许对此连续序列。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-228">The disconnected nature of web apps doesn't allow for this continuous sequence.</span></span> <span data-ttu-id="cbd3d-229">[DbContext](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext(v=VS.103).aspx)读取实体已释放之后呈现一个页面。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-229">The [DbContext](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext(v=VS.103).aspx) that reads an entity is disposed after a page is rendered.</span></span> <span data-ttu-id="cbd3d-230">当`HttpPost``Edit`操作方法调用、 新的请求进行并且您具有的新实例[DbContext](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext(v=VS.103).aspx)，因此你必须手动将实体状态设置为`Modified.`然后当调用`SaveChanges`，实体框架更新数据库行中，所有的列，因为上下文具有无法知道您更改了哪些属性。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-230">When the `HttpPost` `Edit` action method is called, a new request is made and you have a new instance of the [DbContext](https://msdn.microsoft.com/en-us/library/system.data.entity.dbcontext(v=VS.103).aspx), so you have to manually set the entity state to `Modified.` Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>
> 
> <span data-ttu-id="cbd3d-231">如果你想 SQL`Update`语句才能更新字段的用户实际更改，以便它们可用时，可以以某种方式 （如隐藏字段） 保存的原始值`HttpPost``Edit`调用方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-231">If you want the SQL `Update` statement to update only the fields that the user actually changed, you can save the original values in some way (such as hidden fields) so that they are available when the `HttpPost` `Edit` method is called.</span></span> <span data-ttu-id="cbd3d-232">然后你可以创建`Student`实体使用原始值，调用`Attach`实体，该原始版本的方法的新值更新实体的值，然后调用`SaveChanges.`详细信息，请参阅[实体状态和 SaveChanges](https://msdn.microsoft.com/en-us/data/jj592676)和[本地数据](https://msdn.microsoft.com/en-us/data/jj592872)MSDN 数据开发人员中心中。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-232">Then you can create a `Student` entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges.` For more information, see [Entity states and SaveChanges](https://msdn.microsoft.com/en-us/data/jj592676) and [Local Data](https://msdn.microsoft.com/en-us/data/jj592872) in the MSDN Data Developer Center.</span></span>


<span data-ttu-id="cbd3d-233">中的 HTML 和 Razor 代码*Views\Student\Edit.cshtml*类似于你在中看到*Create.cshtml*，并需进行任何更改。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-233">The HTML and Razor code in *Views\Student\Edit.cshtml* is similar to what you saw in *Create.cshtml*, and no changes are required.</span></span>

<span data-ttu-id="cbd3d-234">通过选择运行页面**学生**选项卡，然后单击**编辑**超链接。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-234">Run the page by selecting the **Students** tab and then clicking an **Edit** hyperlink.</span></span>

![Student_Edit_page](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image8.png)

<span data-ttu-id="cbd3d-236">更改某些数据，再单击**保存**。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-236">Change some of the data and click **Save**.</span></span> <span data-ttu-id="cbd3d-237">你看到索引页面中的更改的数据。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-237">You see the changed data in the Index page.</span></span>

![Students_Index_page_after_edit](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image9.png)

## <a name="updating-the-delete-page"></a><span data-ttu-id="cbd3d-239">更新删除页</span><span class="sxs-lookup"><span data-stu-id="cbd3d-239">Updating the Delete Page</span></span>

<span data-ttu-id="cbd3d-240">在*Controllers\StudentController.cs*的模板代码`HttpGet``Delete`方法使用`Find`方法来检索所选`Student`实体，当你在中看到`Details`和`Edit`方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-240">In *Controllers\StudentController.cs*, the template code for the `HttpGet` `Delete` method uses the `Find` method to retrieve the selected `Student` entity, as you saw in the `Details` and `Edit` methods.</span></span> <span data-ttu-id="cbd3d-241">但是，若要实现自定义错误消息时对调用`SaveChanges`失败，需要将某些功能添加到此方法，其相应的视图。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-241">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="cbd3d-242">当你看到的针对更新，并创建操作，删除操作需要两个操作方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-242">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="cbd3d-243">调用以响应 GET 请求的方法显示为用户提供了机会批准或取消删除操作的视图。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-243">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="cbd3d-244">如果用户批准它，则创建 POST 请求。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-244">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="cbd3d-245">在这种情况， `HttpPost` `Delete`调用方法，该方法然后实际执行删除操作。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-245">When that happens, the `HttpPost` `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="cbd3d-246">你将添加`try-catch`阻止`HttpPost``Delete`方法以处理更新数据库时可能出现的任何错误。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-246">You'll add a `try-catch` block to the `HttpPost` `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="cbd3d-247">如果发生错误， `HttpPost` `Delete`方法调用`HttpGet``Delete`方法，将其传递参数，该值指示发生错误。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-247">If an error occurs, the `HttpPost` `Delete` method calls the `HttpGet` `Delete` method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="cbd3d-248">`HttpGet Delete`方法然后重新显示确认页以及错误消息，向用户提供机会取消或重试。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-248">The `HttpGet Delete` method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

1. <span data-ttu-id="cbd3d-249">替换`HttpGet``Delete`替换为以下代码，它管理错误报告的操作方法：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-249">Replace the `HttpGet` `Delete` action method with the following code, which manages error reporting:</span></span> 

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample12.cs?highlight=1,7-10)]

    <span data-ttu-id="cbd3d-250">此代码接受[可选参数](https://msdn.microsoft.com/en-us/library/dd264739.aspx)，该值指示是否在出现故障，若要保存更改后调用该方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-250">This code accepts an [optional parameter](https://msdn.microsoft.com/en-us/library/dd264739.aspx) that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="cbd3d-251">此参数是`false`时`HttpGet``Delete`不上一次失败的情况下调用方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-251">This parameter is `false` when the `HttpGet` `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="cbd3d-252">当调用`HttpPost``Delete`方法中对数据库更新错误响应，该参数是`true`和一条错误消息传递给视图。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-252">When it is called by the `HttpPost` `Delete` method in response to a database update error, the parameter is `true` and an error message is passed to the view.</span></span>
- <span data-ttu-id="cbd3d-253">替换`HttpPost``Delete`操作方法 (名为`DeleteConfirmed`) 替换为以下代码，该执行实际的删除操作并捕获任何数据库更新错误。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-253">Replace the `HttpPost` `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample13.cs)]

    <span data-ttu-id="cbd3d-254">此代码检索所选的实体，然后调用[删除](https://msdn.microsoft.com/en-us/library/system.data.entity.dbset.remove(v=vs.103).aspx)方法将实体的状态设置为`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-254">This code retrieves the selected entity, then calls the [Remove](https://msdn.microsoft.com/en-us/library/system.data.entity.dbset.remove(v=vs.103).aspx) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="cbd3d-255">当`SaveChanges`调用时，SQL`DELETE`生成命令。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-255">When `SaveChanges` is called, a SQL `DELETE` command is generated.</span></span> <span data-ttu-id="cbd3d-256">您还已更改的操作方法名称`DeleteConfirmed`到`Delete`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-256">You have also changed the action method name from `DeleteConfirmed` to `Delete`.</span></span> <span data-ttu-id="cbd3d-257">名为的基架的代码`HttpPost``Delete`方法`DeleteConfirmed`以便`HttpPost`方法一个唯一的签名。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-257">The scaffolded code named the `HttpPost` `Delete` method `DeleteConfirmed` to give the `HttpPost` method a unique signature.</span></span> <span data-ttu-id="cbd3d-258">（CLR 需要具有不同的方法参数的重载的方法。）签名是唯一的现在可以坚持使用 MVC 约定，使用相同的名称用于`HttpPost`和`HttpGet`删除方法。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-258">( The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the `HttpPost` and `HttpGet` delete methods.</span></span>

    <span data-ttu-id="cbd3d-259">如果提高大容量应用程序中的性能是优先级，则无法避免不必要的 SQL 查询，以检索行，通过将调用的代码行`Find`和`Remove`方法替换为以下代码：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-259">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query to retrieve the row by replacing the lines of code that call the `Find` and `Remove` methods with the following code:</span></span>

    [!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample14.cs)]

    <span data-ttu-id="cbd3d-260">此代码实例化`Student`实体使用仅的主键值然后将实体状态设置为`Deleted`。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-260">This code instantiates a `Student` entity using only the primary key value and then sets the entity state to `Deleted`.</span></span> <span data-ttu-id="cbd3d-261">这就是所有实体框架需要以便删除该实体。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-261">That's all that the Entity Framework needs in order to delete the entity.</span></span>

    <span data-ttu-id="cbd3d-262">如前所述， `HttpGet` `Delete`方法不会删除数据。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-262">As noted, the `HttpGet` `Delete` method doesn't delete the data.</span></span> <span data-ttu-id="cbd3d-263">执行 delete 操作以响应 GET 请求 （或对于此问题，执行任何编辑操作，创建操作或更改数据的任何其他操作） 会产生安全风险。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-263">Performing a delete operation in response to a GET request (or for that matter, performing any edit operation, create operation, or any other operation that changes data) creates a security risk.</span></span> <span data-ttu-id="cbd3d-264">有关详细信息，请参阅[ASP.NET MVC 提示 #46-不要使用删除的链接，因为他们创建的安全漏洞](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx)Stephen Walther 博客上。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-264">For more information, see [ASP.NET MVC Tip #46 — Don't use Delete Links because they create Security Holes](http://stephenwalther.com/blog/archive/2009/01/21/asp.net-mvc-tip-46-ndash-donrsquot-use-delete-links-because.aspx) on Stephen Walther's blog.</span></span>
- <span data-ttu-id="cbd3d-265">在*Views\Student\Delete.cshtml*，添加一条错误消息之间`h2`标题和`h3`标题下，如下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-265">In *Views\Student\Delete.cshtml*, add an error message between the `h2` heading and the `h3` heading, as shown in the following example:</span></span>

    [!code-cshtml[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample15.cshtml?highlight=2)]

    <span data-ttu-id="cbd3d-266">通过选择运行页面**学生**选项卡上，单击**删除**超链接：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-266">Run the page by selecting the **Students** tab and clicking a **Delete** hyperlink:</span></span>

    ![Student_Delete_page](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/_static/image10.png)
- <span data-ttu-id="cbd3d-268">单击**删除**。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-268">Click **Delete**.</span></span> <span data-ttu-id="cbd3d-269">索引页面显示没有已删除的学生。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-269">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="cbd3d-270">(你将看到举例说明的错误处理代码中的操作中[并发教程](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md)。)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-270">(You'll see an example of the error handling code in action in the [concurrency tutorial](handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md).)</span></span>

## <a name="closing-database-connections"></a><span data-ttu-id="cbd3d-271">关闭数据库连接</span><span class="sxs-lookup"><span data-stu-id="cbd3d-271">Closing Database Connections</span></span>

<span data-ttu-id="cbd3d-272">若要关闭的数据库连接并释放它们尽快持有的资源，请释放上下文实例完成后使用它。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-272">To close database connections and free up the resources they hold as soon as possible, dispose the context instance when you are done with it.</span></span> <span data-ttu-id="cbd3d-273">就是为什么基架的代码提供[释放](https://msdn.microsoft.com/en-us/library/system.idisposable.dispose(v=vs.110).aspx)方法末尾`StudentController`类*StudentController.cs*，下面的示例中所示：</span><span class="sxs-lookup"><span data-stu-id="cbd3d-273">That is why the scaffolded code provides a [Dispose](https://msdn.microsoft.com/en-us/library/system.idisposable.dispose(v=vs.110).aspx) method at the end of the `StudentController` class in *StudentController.cs*, as shown in the following example:</span></span>

[!code-csharp[Main](implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application/samples/sample16.cs)]

<span data-ttu-id="cbd3d-274">基`Controller`类已经实现`IDisposable`接口，所以此代码只需将添加到替代`Dispose(bool)`方法以显式释放上下文实例。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-274">The base `Controller` class already implements the `IDisposable` interface, so this code simply adds an override to the `Dispose(bool)` method to explicitly dispose the context instance.</span></span>

<a id="transactions"></a>
## <a name="handling-transactions"></a><span data-ttu-id="cbd3d-275">处理事务</span><span class="sxs-lookup"><span data-stu-id="cbd3d-275">Handling Transactions</span></span>

<span data-ttu-id="cbd3d-276">默认情况下实体框架隐式实现事务。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-276">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="cbd3d-277">在方案中，对多个行或表进行更改，然后调用`SaveChanges`，实体框架自动可确保所有所做的更改成功或所有失败。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-277">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or all fail.</span></span> <span data-ttu-id="cbd3d-278">如果先完成一些更改，然后，将发生错误，则这些更改可能是自动回滚。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-278">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="cbd3d-279">有关方案，你需要更多的控制-例如，如果你想要包括在实体框架外部事务-中执行的操作，请参阅[使用事务](https://msdn.microsoft.com/en-US/data/dn456843)MSDN 上。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-279">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Working with Transactions](https://msdn.microsoft.com/en-US/data/dn456843) on MSDN.</span></span>

## <a name="summary"></a><span data-ttu-id="cbd3d-280">摘要</span><span class="sxs-lookup"><span data-stu-id="cbd3d-280">Summary</span></span>

<span data-ttu-id="cbd3d-281">你现在具有一组完整的执行有关的简单 CRUD 操作的页`Student`实体。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-281">You now have a complete set of pages that perform simple CRUD operations for `Student` entities.</span></span> <span data-ttu-id="cbd3d-282">MVC 帮助器用于生成数据字段的 UI 元素。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-282">You used MVC helpers to generate UI elements for data fields.</span></span> <span data-ttu-id="cbd3d-283">MVC 帮助器有关的详细信息，请参阅[呈现窗体使用 HTML 帮助器](https://msdn.microsoft.com/en-us/library/dd410596(v=VS.98).aspx)（该页是 MVC 3 且不仍适用于 MVC 5）。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-283">For more information about MVC helpers, see [Rendering a Form Using HTML Helpers](https://msdn.microsoft.com/en-us/library/dd410596(v=VS.98).aspx) (the page is for MVC 3 but is still relevant for MVC 5).</span></span>

<span data-ttu-id="cbd3d-284">在下一教程将通过添加排序和分页扩展索引页的功能。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-284">In the next tutorial you'll expand the functionality of the Index page by adding sorting and paging.</span></span>

<span data-ttu-id="cbd3d-285">请在如何喜欢本教程的方式，我们可以提高上，留下反馈。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-285">Please leave feedback on how you liked this tutorial and what we could improve.</span></span> <span data-ttu-id="cbd3d-286">你还可以请求新主题[教我编写代码](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code)。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-286">You can also request new topics at [Show Me How With Code](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code).</span></span>

<span data-ttu-id="cbd3d-287">在找不到其他实体框架资源的链接[ASP.NET 数据访问的推荐资源](../../../../whitepapers/aspnet-data-access-content-map.md)。</span><span class="sxs-lookup"><span data-stu-id="cbd3d-287">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="cbd3d-288">[上一页](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)
[下一页](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)</span><span class="sxs-lookup"><span data-stu-id="cbd3d-288">[Previous](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)
[Next](sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md)</span></span>
