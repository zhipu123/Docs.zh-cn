---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
title: "添加一条新记录 (C#) 时包括文件上载选项 |Microsoft 文档"
author: rick-anderson
description: "本教程演示如何创建一个 Web 界面，允许用户同时输入文本数据，并将二进制文件上载。 为了说明选项可用 t..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/27/2007
ms.topic: article
ms.assetid: 362ade25-3965-4fb2-88d2-835c4786244f
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
msc.type: authoredcontent
ms.openlocfilehash: fcb791868e6af9eef1614d039d11ef5232b40af5
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/10/2017
---
<a name="including-a-file-upload-option-when-adding-a-new-record-c"></a><span data-ttu-id="d5d9e-104">包括文件上载选项，在添加新的记录 (C#)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-104">Including a File Upload Option When Adding a New Record (C#)</span></span>
====================
<span data-ttu-id="d5d9e-105">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d5d9e-106">[下载示例应用程序](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe)或[下载 PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-106">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)</span></span>

> <span data-ttu-id="d5d9e-107">本教程演示如何创建一个 Web 界面，允许用户同时输入文本数据，并将二进制文件上载。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="d5d9e-108">为了说明可用于存储二进制数据的选项，一个文件将保存在数据库中时的其他存储在文件系统。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>


## <a name="introduction"></a><span data-ttu-id="d5d9e-109">介绍</span><span class="sxs-lookup"><span data-stu-id="d5d9e-109">Introduction</span></span>

<span data-ttu-id="d5d9e-110">在前面的两个教程中我们探讨了用于存储与应用程序的数据模型，介绍了如何使用 FileUpload 控件将文件从客户端发送到 web 服务器，并已了解如何将此二进制数据呈现数据 W 中关联的二进制数据的技术eb 控件。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="d5d9e-111">我们遇到有待讨论如何通过将上载的数据与数据模型中，关联。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="d5d9e-112">在本教程中我们将创建一个用于添加新类别 web 页。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="d5d9e-113">除类别的名称和说明的文本框中，此页需要包括两个 FileUpload 控件另一个用于新的类别的图片，另一个用于小册子中。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="d5d9e-114">将新记录 s 中直接存储上载的图片`Picture`列，而小册子将保存到`~/Brochures`替换为新记录 s 中保存的文件的路径的文件夹`BrochurePath`列。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="d5d9e-115">然后再创建此新的 web 页面，我们将需要更新体系结构。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="d5d9e-116">`CategoriesTableAdapter` S 主查询未检索`Picture`列。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="d5d9e-117">因此，自动生成`Insert`方法只有输入`CategoryName`， `Description`，和`BrochurePath`字段。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="d5d9e-118">因此，我们需要在所有四个提示的 TableAdapter 中创建的其他方法`Categories`字段。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="d5d9e-119">`CategoriesBLL`业务逻辑层中的类还将需要更新。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="d5d9e-120">步骤 1： 添加`InsertWithPicture`方法`CategoriesTableAdapter`</span><span class="sxs-lookup"><span data-stu-id="d5d9e-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="d5d9e-121">当我们创建`CategoriesTableAdapter`进来[创建数据访问层](../introduction/creating-a-data-access-layer-cs.md)教程中，我们将其配置为自动生成`INSERT`， `UPDATE`，和`DELETE`语句基于主查询。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="d5d9e-122">此外，我们已指示要采用的 DB 直接的方法，创建方法的 TableAdapter `Insert`， `Update`，和`Delete`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="d5d9e-123">这些方法来执行自动生成`INSERT`， `UPDATE`，和`DELETE`语句，因此，接受基于主查询返回的列的输入的参数。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="d5d9e-124">在[上载文件](uploading-files-cs.md)教程我们扩充`CategoriesTableAdapter`s 要使用的主查询`BrochurePath`列。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-124">In the [Uploading Files](uploading-files-cs.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="d5d9e-125">由于`CategoriesTableAdapter`s 主查询未引用`Picture`列中，我们不能添加新的记录或使用的值更新现有记录`Picture`列。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="d5d9e-126">为了捕获此信息，我们可以创建一个新方法中专门用于插入二进制数据的记录的 TableAdapter 或者我们可以自定义自动生成`INSERT`语句。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="d5d9e-127">自定义自动生成的问题`INSERT`语句是我们风险具有覆盖由向导我们自定义项。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="d5d9e-128">例如，假设我们自定义`INSERT`语句以包含使用`Picture`列。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="d5d9e-129">这将更新 TableAdapter 的`Insert`方法以包括类别的图片 s 二进制数据的其他输入的参数。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="d5d9e-130">我们然后可以在业务逻辑层，若要使用此 DAL 方法并且调用表示层，通过此 BLL 方法中创建一种方法并的所有内容的方式非常工作。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="d5d9e-131">也就是说，只有在下次时我们配置了通过 TableAdapter 配置向导 TableAdapter。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="d5d9e-132">向导已完成，到我们自定义项时，就会立即`INSERT`语句，都会覆盖，`Insert`方法将恢复到原来的形式，并且我们的代码将无法再编译 ！</span><span class="sxs-lookup"><span data-stu-id="d5d9e-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="d5d9e-133">使用存储的过程而不临时的 SQL 语句时，此干扰将是一个非问题。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="d5d9e-134">将来的教程将探讨在数据访问层中使用而不是临时的 SQL 语句的存储的过程。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>


<span data-ttu-id="d5d9e-135">若要避免此潜在难题，而不是自定义自动生成 SQL 语句，请让 s 改为 TableAdapter 创建新方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="d5d9e-136">此方法中，名为`InsertWithPicture`，将接受的值`CategoryName`， `Description`， `BrochurePath`，和`Picture`列和执行`INSERT`将所有四个值存储在一条新记录中的语句。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="d5d9e-137">打开该类型化数据集，然后从设计器中，右键单击`CategoriesTableAdapter`s 标头，然后从上下文菜单中选择添加查询。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="d5d9e-138">这将启动 TableAdapter 查询配置向导的说明进行操作，它首先会询问我们 TableAdapter 查询访问数据库的方式。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="d5d9e-139">选择使用 SQL 语句，然后单击下一步。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="d5d9e-140">下一步将提示输入查询的类型生成。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="d5d9e-141">由于我们重新创建一个查询来添加到新的记录`Categories`表、 选择插入，然后单击下一步。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>


<span data-ttu-id="d5d9e-142">[![选择插入选项](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)</span></span>

<span data-ttu-id="d5d9e-143">**图 1**： 选择插入选项 ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))</span></span>


<span data-ttu-id="d5d9e-144">现在，我们需要指定`INSERT`SQL 语句。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="d5d9e-145">向导会自动建议使用`INSERT`语句对应于 TableAdapter s 主查询。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="d5d9e-146">在这种情况下，它 s`INSERT`插入语句`CategoryName`， `Description`，和`BrochurePath`值。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="d5d9e-147">Update 语句，以便`Picture`列是包含沿`@Picture`参数，如下所示：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>


[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample1.sql)]

<span data-ttu-id="d5d9e-148">在向导的最后一个屏幕可让我们将新的 TableAdapter 方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="d5d9e-149">输入`InsertWithPicture`并单击完成。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-149">Enter `InsertWithPicture` and click Finish.</span></span>


<span data-ttu-id="d5d9e-150">[![新的 TableAdapter 方法 InsertWithPicture 名称](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)</span></span>

<span data-ttu-id="d5d9e-151">**图 2**： 将新的 TableAdapter 方法`InsertWithPicture`([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))</span></span>


## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="d5d9e-152">步骤 2： 更新的业务逻辑层</span><span class="sxs-lookup"><span data-stu-id="d5d9e-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="d5d9e-153">由于表示层应仅与业务逻辑层进行交互，而不是我们绕过它以直接转至数据访问层，需要创建调用我们刚刚创建的 DAL 方法的 BLL 方法 (`InsertWithPicture`)。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="d5d9e-154">对于本教程中，创建中的方法`CategoriesBLL`类名为`InsertWithPicture`接受作为输入的三个`string`s 和`byte`数组。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `string` s and a `byte` array.</span></span> <span data-ttu-id="d5d9e-155">`string`输入的参数只用于类别的名称、 说明和小册子文件路径时`byte`数组为类别的图片的二进制内容。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-155">The `string` input parameters are for the category s name, description, and brochure file path, while the `byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="d5d9e-156">如下面的代码所示，此 BLL 方法将调用相应的 DAL 方法：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample2.cs)]

> [!NOTE]
> <span data-ttu-id="d5d9e-157">请确保在添加之前保存类型化数据集`InsertWithPicture`为 BLL 的方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="d5d9e-158">由于`CategoriesTableAdapter`类代码是自动生成基于类型化数据集，如果 don t 首先将所做的更改保存到类型化数据集`Adapter`属性获胜 t 了解`InsertWithPicture`方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won t know about the `InsertWithPicture` method.</span></span>


## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="d5d9e-159">步骤 3： 列出现有类别和其二进制数据</span><span class="sxs-lookup"><span data-stu-id="d5d9e-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="d5d9e-160">在本教程中我们将创建一个页面，让最终用户能够将新类别添加到系统提供的新类别的图片和手册。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="d5d9e-161">在[前面教程](displaying-binary-data-in-the-data-web-controls-cs.md)我们用于 GridView TemplateField ImageField 与显示每个类别的名称，说明、 图片和链接以下载其手册。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-cs.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="d5d9e-162">让我们来为本教程中，创建一个页，同时列出所有现有的类别，并允许创建新的复制该功能。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="d5d9e-163">首先打开`DisplayOrDownload.aspx`来自页`BinaryData`文件夹。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="d5d9e-164">请转到源视图并将复制的 GridView 和 ObjectDataSource s 声明性语法，粘贴在`<asp:Content>`中的元素`UploadInDetailsView.aspx`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="d5d9e-165">此外，不要忘记复制通过`GenerateBrochureLink`方法的代码隐藏类从`DisplayOrDownload.aspx`到`UploadInDetailsView.aspx`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>


<span data-ttu-id="d5d9e-166">[![复制并粘贴到 UploadInDetailsView.aspx 从 DisplayOrDownload.aspx 的声明性语法](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)</span></span>

<span data-ttu-id="d5d9e-167">**图 3**： 复制并粘贴从声明性语法`DisplayOrDownload.aspx`到`UploadInDetailsView.aspx`([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))</span></span>


<span data-ttu-id="d5d9e-168">复制的声明性语法后和`GenerateBrochureLink`方法转移到`UploadInDetailsView.aspx`页上，查看通过浏览器以确保所有内容已复制通过正确的页。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="d5d9e-169">你应看到列出的八个类别一个 GridView，包含要下载小册子，以及类别的图片的链接。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>


<span data-ttu-id="d5d9e-170">[![现在，你应看到每个类别以及其二进制数据](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)</span></span>

<span data-ttu-id="d5d9e-171">**图 4**： 你应现在请参阅每个类别沿对其的二进制数据 ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))</span></span>


## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="d5d9e-172">步骤 4： 配置`CategoriesDataSource`支持插入</span><span class="sxs-lookup"><span data-stu-id="d5d9e-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="d5d9e-173">`CategoriesDataSource` ObjectDataSource 由`Categories`GridView 目前不提供插入数据的能力。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="d5d9e-174">若要支持通过此数据源控件插入，我们需要映射其`Insert`到在其基础对象中方法的方法`CategoriesBLL`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="d5d9e-175">具体而言，我们想要将其映射到`CategoriesBLL`返回在步骤 2 中，我们添加的方法`InsertWithPicture`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="d5d9e-176">通过单击从 ObjectDataSource s 智能标记的配置数据源链接启动。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="d5d9e-177">第一个屏幕中显示数据源配置要使用的对象`CategoriesBLL`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="d5d9e-178">保留此设置为-前进到定义数据方法屏幕旁边单击。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="d5d9e-179">将移动到插入选项卡，选取`InsertWithPicture`从下拉列表的方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="d5d9e-180">单击完成以完成向导。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-180">Click Finish to complete the wizard.</span></span>


<span data-ttu-id="d5d9e-181">[![配置对象数据源以使用 InsertWithPicture 方法](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)</span></span>

<span data-ttu-id="d5d9e-182">**图 5**： 配置对象数据源以使用`InsertWithPicture`方法 ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))</span></span>


> [!NOTE]
> <span data-ttu-id="d5d9e-183">完成向导之后，Visual Studio 可能会要求是否你要刷新字段和密钥，这将重新生成数据 Web 控制字段。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="d5d9e-184">因为选择是将覆盖您所做的任何字段自定义，请选择否，。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>


<span data-ttu-id="d5d9e-185">完成向导后，ObjectDataSource 将现在包含的值其`InsertMethod`属性，以及`InsertParameters`对于四个类别列中，如下面的声明性标记所阐释：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="d5d9e-186">步骤 5： 创建插入接口</span><span class="sxs-lookup"><span data-stu-id="d5d9e-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="d5d9e-187">在首次涵盖[概述的插入、 更新和删除数据](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)，说明提供一个内置的插入界面，可以使用支持插入的数据源控件时使用。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="d5d9e-188">让我们来说明如何控件添加到此页面上方 GridView 将永久呈现其插入的界面，允许用户快速添加新类别。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="d5d9e-189">在说明中添加新类别，在其下的 GridView 将自动刷新并显示新类别。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="d5d9e-190">通过从工具箱中拖动到上面 GridView，设置设计器中拖动说明如何开始其`ID`属性`NewCategory`和清除`Height`和`Width`属性值。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="d5d9e-191">从说明 s 智能标记，请将其绑定到现有`CategoriesDataSource`，然后选中启用插入复选框。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>


<span data-ttu-id="d5d9e-192">[![将说明如何绑定到 CategoriesDataSource 并启用插入](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)</span></span>

<span data-ttu-id="d5d9e-193">**图 6**： 绑定到说明`CategoriesDataSource`和启用插入 ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))</span></span>


<span data-ttu-id="d5d9e-194">若要永久呈现在其插入界面说明，设置其`DefaultMode`属性`Insert`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="d5d9e-195">请注意，说明有五个 BoundFields `CategoryID`， `CategoryName`， `Description`， `NumberOfProducts`，和`BrochurePath`尽管`CategoryID`因为插入接口不呈现 BoundField 其`InsertVisible`属性设置为`false`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `false`.</span></span> <span data-ttu-id="d5d9e-196">因为它们是返回的列，所以存在这些 BoundFields`GetCategories()`方法，即 ObjectDataSource 调用以检索其数据。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="d5d9e-197">用于插入，但是，我们不想让用户指定的值`NumberOfProducts`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="d5d9e-198">此外，我们需要以允许它们上载为新的类别图片以及上载小册子 PDF。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="d5d9e-199">删除`NumberOfProducts`从说明如何一起删除，然后更新 BoundField`HeaderText`属性`CategoryName`和`BrochurePath`BoundFields 为类别并小册子中，分别。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="d5d9e-200">接下来，将转换`BrochurePath`转换为 TemplateField BoundField 和添加图片，为新 TemplateField 提供此新 TemplateField`HeaderText`图片的值。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="d5d9e-201">移动`Picture`TemplateField 使之之间`BrochurePath`TemplateField 和 CommandField。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>


![将说明如何绑定到 CategoriesDataSource 并启用插入](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.gif)

<span data-ttu-id="d5d9e-203">**图 7**： 绑定到说明`CategoriesDataSource`并启用插入</span><span class="sxs-lookup"><span data-stu-id="d5d9e-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>


<span data-ttu-id="d5d9e-204">如果你转换`BrochurePath`转换通过编辑字段对话框中为 TemplateField BoundField TemplateField 包括`ItemTemplate`， `EditItemTemplate`，和`InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="d5d9e-205">仅`InsertItemTemplate`是需要但是，因此请尝试删除了其他两个模板。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="d5d9e-206">此时你说明如何 s 声明性语法应如下所示：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="d5d9e-207">手册和图片字段添加 FileUpload 控件</span><span class="sxs-lookup"><span data-stu-id="d5d9e-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="d5d9e-208">目前， `BrochurePath` TemplateField s`InsertItemTemplate`包含文本框中，虽然`Picture`TemplateField 不包含任何模板。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="d5d9e-209">我们需要更新这些两个 TemplateField 的`InsertItemTemplate`以使用 FileUpload 控件。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="d5d9e-210">从说明 s 智能标记中，选择编辑模板选项，然后选择`BrochurePath`TemplateField 的`InsertItemTemplate`从下拉列表。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="d5d9e-211">删除文本框中，然后将 FileUpload 控件从工具箱拖入模板。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="d5d9e-212">设置 FileUpload 控件 s`ID`到`BrochureUpload`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="d5d9e-213">同样，FileUpload 将控件添加到`Picture`TemplateField 的`InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="d5d9e-214">将此 FileUpload 控制 s 设置`ID`到`PictureUpload`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>


<span data-ttu-id="d5d9e-215">[![FileUpload 控件添加到 InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)</span></span>

<span data-ttu-id="d5d9e-216">**图 8**: FileUpload 将控件添加到`InsertItemTemplate`([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))</span></span>


<span data-ttu-id="d5d9e-217">完成后这些添加的内容，请将为两个 TemplateField s 声明性语法：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample5.aspx)]

<span data-ttu-id="d5d9e-218">当用户将添加新类别时，我们想要确保的手册和图片的文件类型正确。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="d5d9e-219">对于小册子中，用户必须提供 PDF。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="d5d9e-220">对于本图中，我们需要用户上载一个图像文件，但我们允许*任何*图像文件或仅图像文件的特定类型，例如 Gif 或 Jpg？</span><span class="sxs-lookup"><span data-stu-id="d5d9e-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="d5d9e-221">若要允许不同的文件类型，d 我们需要扩展`Categories`架构以包括捕获的文件类型，以便可以将此类型发送到客户端通过列`Response.ContentType`中`DisplayCategoryPicture.aspx`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="d5d9e-222">由于我们不具有此类的列，它明智的做法是以将用户限制到仅提供特定的图像文件类型。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="d5d9e-223">`Categories`表 s 现有的映像是位图，但 Jpg 图像提供通过 web 服务的更合适文件格式。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="d5d9e-224">如果用户上载不正确的文件类型时，我们需要取消插入并显示一条消息，指示的问题。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="d5d9e-225">添加下面说明的标签 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="d5d9e-226">设置其`ID`属性`UploadWarning`，清除出其`Text`属性，设置`CssClass`警告，属性和`Visible`和`EnableViewState`属性设置为`false`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="d5d9e-227">`Warning` CSS 类中定义`Styles.css`并呈现大型、 红色、 斜体化、 加粗字体中的文本。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="d5d9e-228">理想情况下，`CategoryName`和`Description`BoundFields 将转换为 TemplateFields 和自定义其插入接口。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="d5d9e-229">`Description`插入接口，例如，将可能会更好地适合通过多行文本框。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="d5d9e-230">并且由于`CategoryName`列不接受`NULL`值，应添加 RequiredFieldValidator 以确保用户的新类别的名称提供一个值。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="d5d9e-231">这些步骤作为练习从左到读取器。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="d5d9e-232">将回指[自定义的数据修改界面](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md)的深入探讨了补充的数据修改接口。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) for an in-depth look at augmenting the data modification interfaces.</span></span>


## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="d5d9e-233">步骤 6： 将上载的小册子保存到 Web 服务器的文件系统</span><span class="sxs-lookup"><span data-stu-id="d5d9e-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="d5d9e-234">当用户输入的值的新类别，然后单击插入按钮时，产生的回发和插入工作流展开。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="d5d9e-235">首先，说明如何 s [ `ItemInserting`事件](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx)激发。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="d5d9e-236">接下来，ObjectDataSource s`Insert()`调用方法时，这将导致新记录添加到`Categories`表。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="d5d9e-237">在此之后，说明如何 s [ `ItemInserted`事件](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx)激发。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="d5d9e-238">之前 ObjectDataSource 的`Insert()`调用方法，我们必须首先确保用户已上载的相应文件类型，然后将小册子 PDF 保存到 web 服务器的文件系统。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="d5d9e-239">创建的事件处理程序说明如何的`ItemInserting`事件并添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample6.cs)]

<span data-ttu-id="d5d9e-240">事件处理程序启动通过引用`BrochureUpload`FileUpload 控件从说明的模板。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="d5d9e-241">然后，如果已上载小册子，上载的文件的扩展检查。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="d5d9e-242">如果不扩展。显示 PDF，然后一条警告，插入被取消时，并在事件处理程序执行结束。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="d5d9e-243">依赖于上载的文件的扩展名不是确保上载的文件的 PDF 文档攻击性技术。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="d5d9e-244">用户可能具有有效的 PDF 文档扩展名`.Brochure`，或无法拍摄非 PDF 文档并为它起`.pdf`扩展。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="d5d9e-245">文件 s 二进制内容将需要以编程方式检查以便更最终验证文件类型。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="d5d9e-246">此类全面的方法，不过，往往太过严厉;检查扩展足以满足大多数方案。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>


<span data-ttu-id="d5d9e-247">中所述[上载文件](uploading-files-cs.md)教程，因此该一个用户的上载不会覆盖另一个 s 保存文件到文件系统时必须小心。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-247">As discussed in the [Uploading Files](uploading-files-cs.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="d5d9e-248">对于本教程中我们将尝试使用相同的名称作为上载的文件。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="d5d9e-249">如果已存在的文件中`~/Brochures`directory 与该文件同名，但是，我们将在附加号结束直到找到一个唯一的名称。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="d5d9e-250">例如，如果在用户上载一个名为的小册子文件`Meats.pdf`，但已存在名为的文件`Meats.pdf`中`~/Brochures`文件夹中，我们将保存的文件名称更改为`Meats-1.pdf`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="d5d9e-251">如果存在，我们将尝试`Meats-2.pdf`，依此类推，直到找到唯一的文件名。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="d5d9e-252">下面的代码使用[`File.Exists(path)`方法](https://msdn.microsoft.com/en-us/library/system.io.file.exists.aspx)以确定文件是否已存在具有指定的文件名称。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/en-us/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="d5d9e-253">如果是这样，它将继续尝试小册子中的新文件名称，直到找到不会发生冲突。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample7.cs)]

<span data-ttu-id="d5d9e-254">找到有效的文件名称后, 该文件必须保存到文件系统和 ObjectDataSource 的`brochurePath``InsertParameter`值需要进行更新，以便该文件名写入到数据库。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="d5d9e-255">正如我们所看到的进来*上载文件*教程中，保存该文件可以使用 FileUpload 控件的`SaveAs(path)`方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="d5d9e-256">若要更新 ObjectDataSource s`brochurePath`参数，使用`e.Values`集合。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample8.cs)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="d5d9e-257">步骤 7： 将上载的图片保存到数据库</span><span class="sxs-lookup"><span data-stu-id="d5d9e-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="d5d9e-258">若要将已上载的图片存储在新`Categories`记录，我们需要将上载的二进制内容分配给 ObjectDataSource s`picture`中说明如何的参数`ItemInserting`事件。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="d5d9e-259">我们进行此分配之前，但是，我们需要首先请确保已上载的图片是 JPG 和不某些其他图像类型。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="d5d9e-260">如下所示步骤 6，让我们来使用已上载的图片的文件扩展名来确定其类型。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="d5d9e-261">虽然`Categories`表允许`NULL`值`Picture`列中，当前所有类别有图片。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="d5d9e-262">让我们来强制用户在添加新类别通过此页时提供图片。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="d5d9e-263">下面的代码检查以确保已上载图片，并且它具有相应的扩展。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample9.cs)]

<span data-ttu-id="d5d9e-264">应将此代码放置*之前*步骤 6 中的代码，以便如果图片上载问题，事件处理程序将终止之前小册子文件保存到文件系统。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="d5d9e-265">假设已上载了相应的文件，将已上载的二进制内容分配到图片参数的值与下面的代码行：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample10.cs)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="d5d9e-266">完整`ItemInserting`事件处理程序</span><span class="sxs-lookup"><span data-stu-id="d5d9e-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="d5d9e-267">为了保持完整性，下面是`ItemInserting`其完整的事件处理程序：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample11.cs)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="d5d9e-268">步骤 8： 修复`DisplayCategoryPicture.aspx`页</span><span class="sxs-lookup"><span data-stu-id="d5d9e-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="d5d9e-269">允许 s 花片刻时间以测试插入接口和`ItemInserting`创建在过去几个步骤的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="d5d9e-270">请访问`UploadInDetailsView.aspx`页上通过浏览器并尝试添加一个类别，但省略图片，或者指定非 JPG 图片或非 PDF 手册。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="d5d9e-271">在任何这些情况下，将显示一条错误消息和插入工作流取消。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>


<span data-ttu-id="d5d9e-272">[![显示如果上载无效的文件类型是一条警告消息](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)</span></span>

<span data-ttu-id="d5d9e-273">**图 9**: 警告消息是显示如果上载无效的文件类型 ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))</span></span>


<span data-ttu-id="d5d9e-274">一次你已验证的页面要求图片要上载和获胜的 t 接受非 PDF 或非 JPG 文件，添加具有有效的 JPG 图片的新类别将小册子字段留空。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-274">Once you have verified that the page requires a picture to be uploaded and won t accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="d5d9e-275">单击插入按钮后，页面将回发，一条新记录将添加到`Categories`表直接在数据库中存储的已上载的图像 s 二进制内容。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="d5d9e-276">GridView 更新，并显示新添加的类别中，行，但如图 10 所示，新的类别的图片不正确呈现。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>


<span data-ttu-id="d5d9e-277">[![新的类别图不显示的 s](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)</span></span>

<span data-ttu-id="d5d9e-278">**图 10**： 图不显示的新类别 s ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))</span></span>


<span data-ttu-id="d5d9e-279">不显示新图片的原因是因为`DisplayCategoryPicture.aspx`返回指定的类别的图片的页面已配置为处理 OLE 标头的位图。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="d5d9e-280">从中提取出来此 78 字节的标头`Picture`列 s 二进制内容在发送之前回客户端。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="d5d9e-281">但没有此 OLE 标题，则我们只需上载为新的类别的 JPG 文件。因此，根据需要，有效字节即将从映像 s 二进制数据中删除。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="d5d9e-282">由于现在有两个位图与 OLE 标头中的 Jpg`Categories`表，我们需要更新`DisplayCategoryPicture.aspx`，以便其不去除原始八个类别的 OLE 标头，绕过较新的类别记录此去除。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="d5d9e-283">在我们的下一教程中，我们将查看如何更新现有记录的映像，并且我们将更新所有旧的类别图片，以便它们 Jpg。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="d5d9e-284">现在，不过，使用下面的代码`DisplayCategoryPicture.aspx`去除仅用于这些原始的八个分类的 OLE 标头：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample12.cs)]

<span data-ttu-id="d5d9e-285">进行此更改后，JPG 图像在 GridView 的现在正确呈现。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>


<span data-ttu-id="d5d9e-286">[![新的类别的 JPG 图像是正确呈现](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)</span></span>

<span data-ttu-id="d5d9e-287">**图 11**： 新的类别的 JPG 图像是正确呈现 ([单击以查看实际尺寸的图像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="d5d9e-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))</span></span>


## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="d5d9e-288">步骤 9： 删除小册子中的遇到了异常</span><span class="sxs-lookup"><span data-stu-id="d5d9e-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="d5d9e-289">在 web 服务器的文件系统上存储二进制数据的挑战之一是它引入了断开连接之间的数据模型和其二进制数据。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="d5d9e-290">因此，只要记录被删除，必须还删除文件系统上的相应二进制数据。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="d5d9e-291">这可能会在插入时，也发挥。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="d5d9e-292">考虑以下方案： 用户添加新类别中，指定有效的图片和手册。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="d5d9e-293">单击插入按钮，产生的回发加以说明的`ItemInserting`事件激发，将小册子中保存到 web 服务器的文件系统。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="d5d9e-294">接下来，ObjectDataSource s`Insert()`调用方法，从而调用`CategoriesBLL`类 s`InsertWithPicture`方法，后者将调用`CategoriesTableAdapter`s`InsertWithPicture`方法。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="d5d9e-295">现在，如果数据库处于脱机状态，会发生什么情况，或如果中的错误`INSERT`SQL 语句？</span><span class="sxs-lookup"><span data-stu-id="d5d9e-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="d5d9e-296">清楚地插入将失败，因此没有新的类别行将添加到数据库。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="d5d9e-297">但我们仍有坐在 web 服务器的文件系统上的已上载的小册子文件 ！</span><span class="sxs-lookup"><span data-stu-id="d5d9e-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="d5d9e-298">此文件需要将删除在遇到时插入工作流期间出现的异常。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="d5d9e-299">中所述以前[处理 BLL-和 ASP.NET 页中的 DAL 级别异常](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md)教程中，在它通过各层上传的体系结构的深度内从引发异常时。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="d5d9e-300">在演示文稿层上，我们可以确定是否从说明 s 发生了异常`ItemInserted`事件。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="d5d9e-301">此事件处理程序还提供的值 ObjectDataSource 的`InsertParameters`。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="d5d9e-302">因此，我们可以创建的事件处理程序`ItemInserted`事件检查是否出现异常，如果是这样，删除 ObjectDataSource s 指定的文件`brochurePath`参数：</span><span class="sxs-lookup"><span data-stu-id="d5d9e-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample13.cs)]

## <a name="summary"></a><span data-ttu-id="d5d9e-303">摘要</span><span class="sxs-lookup"><span data-stu-id="d5d9e-303">Summary</span></span>

<span data-ttu-id="d5d9e-304">有多个要添加包含二进制数据的记录提供基于 web 的界面，必须执行的步骤。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="d5d9e-305">如果正在直接到数据库中存储二进制数据，则很有你将需要更新体系结构中，添加特定的方法以处理二进制数据正在插入的位置的情况。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="d5d9e-306">一旦体系结构已更新下, 一步创建插入接口，这可以使用自定义要包括的每个二进制数据字段 FileUpload 控制说明如何完成。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="d5d9e-307">上载的数据然后可以保存到 web 服务器的文件系统或分配给说明 s 中的数据源参数`ItemInserting`事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="d5d9e-308">将二进制数据保存到文件系统需要多个计划，而不直接在数据库中保存数据。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="d5d9e-309">为了避免覆盖另一个 s 的一个用户的上载，必须选择命名方案。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="d5d9e-310">此外，必须采取额外步骤来删除已上载的文件，如果数据库插入操作失败。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="d5d9e-311">我们现在有能够将新类别添加到具有小册子和状况，但我们系统遇到有待看一下如何更新现有类别 s 二进制数据或如何正确删除已删除的类别的二进制数据。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="d5d9e-312">在下一教程中，我们将探讨这两个主题。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="d5d9e-313">尽情享受编程 ！</span><span class="sxs-lookup"><span data-stu-id="d5d9e-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="d5d9e-314">关于作者</span><span class="sxs-lookup"><span data-stu-id="d5d9e-314">About the Author</span></span>

<span data-ttu-id="d5d9e-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七个 ASP/ASP.NET 书籍和的创始人[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年使用与 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d5d9e-316">Scott 的作用是作为独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d5d9e-317">最新书籍是[ *Sam 教授自己 ASP.NET 2.0 24 小时内*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="d5d9e-318">他可以达到在[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)或通过他的博客，其中可以找到在[http://ScottOnWriting.NET](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="d5d9e-319">特别感谢</span><span class="sxs-lookup"><span data-stu-id="d5d9e-319">Special Thanks To</span></span>

<span data-ttu-id="d5d9e-320">本教程系列已由许多有用的审阅者评审。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-320">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="d5d9e-321">本教程中的前导审阅者已 Dave Gardner、 Teresa 墨和伯纳黛特 Leigh。</span><span class="sxs-lookup"><span data-stu-id="d5d9e-321">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="d5d9e-322">对感兴趣查看我即将到来的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="d5d9e-322">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="d5d9e-323">如果是这样，删除我一行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-323">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="d5d9e-324">[上一页](displaying-binary-data-in-the-data-web-controls-cs.md)
[下一页](updating-and-deleting-existing-binary-data-cs.md)</span><span class="sxs-lookup"><span data-stu-id="d5d9e-324">[Previous](displaying-binary-data-in-the-data-web-controls-cs.md)
[Next](updating-and-deleting-existing-binary-data-cs.md)</span></span>
